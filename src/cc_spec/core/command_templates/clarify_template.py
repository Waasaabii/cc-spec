"""clarify 命令的模板实现。

该模块为 clarify 命令提供完整的模板内容，包括：
- 命令大纲说明
- 执行步骤详细指引
- 验证检查清单
- 9 大歧义分类指南
- 问题表格格式规范

参考：Spec-Kit 的 clarify 工作流设计
"""

from ..ambiguity import AmbiguityType
from ..ambiguity.detector import get_keywords_by_type, get_type_description
from .base import CommandTemplate, CommandTemplateContext


class ClarifyTemplate(CommandTemplate):
    """clarify 命令的模板实现。

    该命令用于审查提案文档，识别歧义和模糊描述，生成澄清问题供用户确认。
    融合了 OpenSpec 和 Spec-Kit 的设计精华，提供系统化的歧义检测和澄清流程。
    """

    def get_outline(self, ctx: CommandTemplateContext) -> str:
        """获取 clarify 命令的大纲描述。"""
        return """
审查当前变更提案中的歧义和模糊描述，生成最多 5 个高影响力的澄清问题，
并将用户的答案直接编码回提案文档中。

**核心目标：**
- 检测并减少提案中的歧义或缺失决策点
- 最多生成 5 个澄清问题，每个问题必须可以简短回答
- 将澄清结果直接更新到 proposal.md 文档中
- 确保所有高优先级歧义在进入 plan 阶段前得到解决

**适用场景：**
- 在调用 `/plan` 命令之前运行
- 提案文档存在模糊描述或缺失关键决策
- 需要用户确认技术选型或业务规则

**输出产物：**
- 更新后的 proposal.md（包含澄清记录章节）
- 澄清会话记录（`## Clarifications` > `### Session YYYY-MM-DD`）
- 覆盖度摘要表格

**重要原则：**
- 每个问题要么是多选题（2-5 个互斥选项），要么是简短答案（≤5 个词）
- 为每个多选题提供**推荐选项**（基于最佳实践分析）
- 优先处理高影响力歧义（影响架构、数据建模、任务分解、测试设计）
- 问题一次展示一个，逐步收集答案并更新文档
- 支持早期终止（用户说 "done"、"no more"、"proceed"）
""".strip()

    def get_execution_steps(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 clarify 命令的执行步骤。"""
        return [
            # 步骤 1: 加载提案文档
            "**加载提案文档**：\n"
            "   - 读取 `.cc-spec/changes/<change-name>/proposal.md` 文件\n"
            "   - 检查文件是否存在，如不存在则提示用户先运行 `cc-spec specify`\n"
            "   - 记录文档内容到工作内存，后续步骤将基于此内容进行分析",

            # 步骤 2: 结构化歧义与覆盖度扫描
            "**执行结构化歧义与覆盖度扫描**：\n"
            "   使用以下 10 大分类进行扫描，为每个分类标记状态（Clear/Partial/Missing）：\n\n"
            "   **功能范围与行为**：\n"
            "   - 核心用户目标和成功标准\n"
            "   - 明确的超出范围声明\n"
            "   - 用户角色/人物区分\n\n"
            "   **领域与数据模型**：\n"
            "   - 实体、属性、关系\n"
            "   - 身份和唯一性规则\n"
            "   - 生命周期/状态转换\n"
            "   - 数据量/规模假设\n\n"
            "   **交互与用户体验流程**：\n"
            "   - 关键用户旅程/序列\n"
            "   - 错误/空/加载状态\n"
            "   - 可访问性或本地化说明\n\n"
            "   **非功能性质量属性**：\n"
            "   - 性能（延迟、吞吐量目标）\n"
            "   - 可扩展性（水平/垂直、限制）\n"
            "   - 可靠性和可用性（正常运行时间、恢复期望）\n"
            "   - 可观测性（日志、指标、追踪信号）\n"
            "   - 安全和隐私（认证/授权、数据保护、威胁假设）\n"
            "   - 合规/监管约束（如有）\n\n"
            "   **集成与外部依赖**：\n"
            "   - 外部服务/API 和故障模式\n"
            "   - 数据导入/导出格式\n"
            "   - 协议/版本假设\n\n"
            "   **边缘情况与故障处理**：\n"
            "   - 负面场景\n"
            "   - 限流/节流\n"
            "   - 冲突解决（如并发编辑）\n\n"
            "   **约束与权衡**：\n"
            "   - 技术约束（语言、存储、托管）\n"
            "   - 明确的权衡或被拒绝的替代方案\n\n"
            "   **术语与一致性**：\n"
            "   - 规范术语表\n"
            "   - 避免的同义词/弃用术语\n\n"
            "   **完成信号**：\n"
            "   - 验收标准可测试性\n"
            "   - 可衡量的完成定义指标\n\n"
            "   **杂项/占位符**：\n"
            "   - TODO 标记/未解决决策\n"
            "   - 缺乏量化的模糊形容词（\"健壮\"、\"直观\"）",

            # 步骤 3: 生成候选问题队列
            "**生成候选问题队列**（最多 5 个）：\n"
            "   基于扫描结果，内部生成优先级排序的候选问题，应用以下约束：\n\n"
            "   **问题格式要求**：\n"
            "   - 每个问题必须可以用以下方式回答：\n"
            "     • 多选题（2-5 个互斥选项），或\n"
            "     • 简短答案（明确限制：≤5 个词）\n\n"
            "   **优先级规则**：\n"
            "   - 仅包含对以下方面有实质影响的问题：\n"
            "     架构、数据建模、任务分解、测试设计、用户体验、运营准备、合规验证\n"
            "   - 优先覆盖高影响力未解决分类（如安全、数据结构）\n"
            "   - 如果超过 5 个分类未解决，按（影响 × 不确定性）启发式选择前 5 个\n\n"
            "   **排除条件**：\n"
            "   - 已回答的问题\n"
            "   - 琐碎的风格偏好\n"
            "   - 计划级执行细节（除非影响正确性）",

            # 步骤 4: 顺序提问循环
            "**顺序提问循环**（交互式）：\n"
            "   一次展示一个问题，每个问题使用以下格式：\n\n"
            "   **多选题格式**：\n"
            "   ```markdown\n"
            "   ## 问题 [N]: [主题]\n"
            "   \n"
            "   **推荐**: 选项 [X] - [1-2 句推荐理由]\n"
            "   \n"
            "   | 选项 | 描述 |\n"
            "   |------|------|\n"
            "   | A | [选项 A 描述] |\n"
            "   | B | [选项 B 描述] |\n"
            "   | C | [选项 C 描述]（如需要可添加 D/E，最多 5 个）|\n"
            "   | 自定义 | 提供您自己的简短答案（≤5 个词）|\n"
            "   \n"
            "   您可以回复选项字母（如 \"A\"），\n"
            "   说 \"yes\" 或 \"推荐\" 接受推荐选项，\n"
            "   或提供您自己的简短答案。\n"
            "   ```\n\n"
            "   **简短答案格式**（无有意义的离散选项时）：\n"
            "   ```markdown\n"
            "   ## 问题 [N]: [主题]\n"
            "   \n"
            "   **建议**: [您的建议答案] - [简短理由]\n"
            "   \n"
            "   格式: 简短答案（≤5 个词）\n"
            "   您可以说 \"yes\" 或 \"建议\" 接受建议，或提供您自己的答案。\n"
            "   ```\n\n"
            "   **停止条件**：\n"
            "   - 所有关键歧义提前解决（剩余队列项变得不必要）\n"
            "   - 用户发出完成信号（\"done\"、\"no more\"、\"proceed\"）\n"
            "   - 达到 5 个问题限制",

            # 步骤 5: 每个答案后增量更新
            "**每个答案后增量更新文档**：\n"
            "   用户回答后，立即执行以下操作：\n\n"
            "   **a. 确保澄清章节存在**：\n"
            "   - 如果 `## Clarifications` 章节不存在，在概述章节后创建\n"
            "   - 在其下创建 `### Session YYYY-MM-DD` 子标题（今天日期）\n\n"
            "   **b. 记录问答**：\n"
            "   - 追加一行：`- Q: <问题> → A: <最终答案>`\n\n"
            "   **c. 更新相应章节**：\n"
            "   - 功能歧义 → 更新功能需求章节\n"
            "   - 用户交互/角色区分 → 更新用户故事或参与者子章节\n"
            "   - 数据形状/实体 → 更新数据模型（添加字段、类型、关系）\n"
            "   - 非功能约束 → 在非功能/质量属性章节添加/修改可衡量标准\n"
            "   - 边缘情况/负面流程 → 在边缘情况/错误处理章节添加新条目\n"
            "   - 术语冲突 → 规范化整个文档中的术语\n\n"
            "   **d. 处理冲突**：\n"
            "   - 如果澄清使早期模糊陈述无效，替换该陈述而非复制\n"
            "   - 不留下过时的矛盾文本\n\n"
            "   **e. 保存文件**：\n"
            "   - 每次集成后保存 proposal.md 以最小化上下文丢失风险",

            # 步骤 6: 验证
            "**验证**（每次写入后 + 最终通过时执行）：\n"
            "   - 澄清会话中每个已接受答案正好有一条记录（无重复）\n"
            "   - 总提问数（已接受）≤ 5\n"
            "   - 更新的章节中不包含新答案本应解决的模糊占位符\n"
            "   - 不存在矛盾的早期陈述（扫描已移除的无效替代选项）\n"
            "   - Markdown 结构有效；唯一允许的新标题：\n"
            "     `## Clarifications`、`### Session YYYY-MM-DD`\n"
            "   - 术语一致性：所有更新章节中使用相同的规范术语",

            # 步骤 7: 写回更新后的文档
            "**写回更新后的 proposal.md**：\n"
            "   - 确保所有更改已保存到 `.cc-spec/changes/<change-name>/proposal.md`\n"
            "   - 保留格式：不重新排序无关章节；保持标题层级结构\n"
            "   - 保持每个插入的澄清最小化且可测试（避免叙述漂移）",

            # 步骤 8: 报告完成
            "**报告完成**（问题循环结束或提前终止后）：\n"
            "   输出以下信息：\n"
            "   - 提问并回答的问题数量\n"
            "   - 更新后文档的路径\n"
            "   - 涉及的章节列表\n"
            "   - 覆盖度摘要表格，列出每个分类的状态：\n"
            "     • **已解决**（Resolved）：原为 Partial/Missing 且已处理\n"
            "     • **延迟**（Deferred）：超出问题配额或更适合在计划阶段处理\n"
            "     • **清晰**（Clear）：原已充分\n"
            "     • **未解决**（Outstanding）：仍为 Partial/Missing 但影响较低\n"
            "   - 如有 Outstanding 或 Deferred，建议是继续进入 `/plan` 还是稍后再运行 `/clarify`\n"
            "   - 建议的下一步命令",
        ]

    def get_validation_checklist(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 clarify 命令的验证检查清单。"""
        return [
            # 文档读取验证
            "proposal.md 文件已成功读取并解析",
            "文档内容已加载到工作内存",

            # 歧义扫描验证
            "已执行 10 大分类的结构化歧义与覆盖度扫描",
            "每个分类已标记状态（Clear/Partial/Missing）",
            "生成了内部覆盖度图用于问题优先级排序",

            # 问题生成验证
            "候选问题队列已生成（最多 5 个问题）",
            "每个问题符合格式要求（多选题 2-5 选项，或简短答案 ≤5 词）",
            "问题按影响力优先级排序（高影响分类优先）",
            "多选题包含推荐选项及其理由",

            # 问题展示验证
            "问题一次展示一个（非批量展示）",
            "多选题使用表格格式（选项 | 描述）",
            "用户回复已正确验证（选项字母、yes/推荐、或自定义答案）",

            # 文档更新验证
            "`## Clarifications` 章节存在（首次澄清时创建）",
            "`### Session YYYY-MM-DD` 子标题存在（使用今天日期）",
            "每个已接受答案有一条 `Q: ... → A: ...` 记录",
            "相应章节已根据澄清结果更新",
            "无遗留的矛盾早期陈述",

            # 格式验证
            "Markdown 结构有效（无格式错误）",
            "仅添加了允许的新标题（Clarifications、Session 日期）",
            "术语一致性：规范术语在所有更新章节中统一使用",

            # 完成度验证
            "总提问数 ≤ 5",
            "高优先级歧义（DATA_STRUCTURE, INTERFACE, VALIDATION）已解决或延迟",
            "无遗留的 TODO 或 TBD 占位符（在已澄清区域内）",

            # 报告验证
            "已输出提问/回答的问题数量",
            "已输出更新后的 proposal.md 路径",
            "已输出涉及的章节列表",
            "已输出覆盖度摘要表格（每个分类的状态）",
            "已提供下一步建议（proceed to /plan 或 re-run /clarify）",
        ]

    def get_guidelines(self, ctx: CommandTemplateContext) -> str:
        """获取歧义分类的详细说明、行为规则和示例。"""
        guidelines = [
            "## 歧义分类指南",
            "",
            "clarify 命令使用 9 种歧义分类来系统化地识别提案文档中的"
            "模糊描述。以下是各类型的详细说明：",
            "",
            "### 歧义分类表",
            "",
            "| 类型 | 说明 | 典型关键词（中文） | 典型关键词（英文） |",
            "|------|------|-------------------|-------------------|",
        ]

        # 为每种歧义类型生成表格行
        for ambiguity_type in AmbiguityType:
            keywords = get_keywords_by_type(ambiguity_type)
            cn_keywords = [k for k in keywords if any('\u4e00' <= c <= '\u9fff' for c in k)][:5]
            en_keywords = [k for k in keywords if not any('\u4e00' <= c <= '\u9fff' for c in k)][:5]

            type_desc = get_type_description(ambiguity_type)
            # 提取描述的简短版本（去掉具体说明）
            short_desc = type_desc.split(" - ")[0] if " - " in type_desc else type_desc

            guidelines.append(
                f"| **{ambiguity_type.value.upper()}** | {short_desc} | "
                f"{', '.join(cn_keywords)} | {', '.join(en_keywords)} |"
            )

        guidelines.extend([
            "",
            "### 优先级说明",
            "",
            "**高优先级**（必须在 clarify 阶段解决）：",
            "- **DATA_STRUCTURE**：影响后续代码实现的数据模型设计",
            "- **INTERFACE**：影响模块间通信和 API 设计",
            "- **VALIDATION**：影响输入校验和业务规则",
            "",
            "**中优先级**（建议在 clarify 阶段解决）：",
            "- **ERROR_HANDLING**：影响系统稳定性和容错能力",
            "- **SECURITY**：影响系统安全性和数据保护",
            "- **SCOPE**：影响功能边界和工作量评估",
            "",
            "**低优先级**（可以在 plan 阶段解决）：",
            "- **PERFORMANCE**：可以在实现时优化",
            "- **DEPENDENCY**：可以在技术选型时确定",
            "- **UX**：可以在详细设计时完善",
            "",
            "### 行为规则",
            "",
            "**无歧义时**：",
            "- 如果未发现有意义的歧义（或所有潜在问题都是低影响的），回复：",
            '  "未检测到需要正式澄清的关键歧义。" 并建议继续进行下一步。',
            "",
            "**文档缺失时**：",
            "- 如果 proposal.md 不存在，提示用户先运行 `/specify`（不在此创建新规格）。",
            "",
            "**问题限制**：",
            "- 永不超过 5 个总问题（澄清重试不计入新问题）",
            "- 避免推测性的技术栈问题，除非缺失会影响功能清晰度",
            "",
            "**早期终止信号**：",
            '- 尊重用户的早期终止信号（"stop"、"done"、"proceed"）',
            "",
            "**完全覆盖时**：",
            "- 如果因完全覆盖而无需提问，输出简洁的覆盖度摘要（所有分类 Clear），",
            "  然后建议继续。",
            "",
            "**配额用尽时**：",
            "- 如果达到配额但仍有未解决的高影响分类，在 Deferred 下明确标记它们并说明原因。",
            "",
            "### 澄清问题格式示例",
            "",
            "**多选题示例**：",
            "",
            "```markdown",
            "## 问题 1: 用户认证方式",
            "",
            "**推荐**: 选项 A - JWT 是 REST API 的标准选择，无状态且易于扩展",
            "",
            "| 选项 | 描述 |",
            "|------|------|",
            "| A | JWT Token（无状态，适合 REST API）|",
            "| B | Session Cookie（有状态，适合传统 Web 应用）|",
            "| C | OAuth 2.0（适合需要第三方登录的场景）|",
            "| 自定义 | 提供您自己的简短答案（≤5 个词）|",
            "",
            '您可以回复选项字母（如 "A"），',
            '说 "yes" 或 "推荐" 接受推荐选项，',
            "或提供您自己的简短答案。",
            "```",
            "",
            "**简短答案示例**：",
            "",
            "```markdown",
            "## 问题 2: 数据保留期限",
            "",
            "**建议**: 90 天 - 这是日志数据的常见默认值",
            "",
            "格式: 简短答案（≤5 个词）",
            '您可以说 "yes" 或 "建议" 接受建议，或提供您自己的答案。',
            "```",
            "",
            "### 更新文档的原则",
            "",
            "1. **精确替换**：仅替换包含歧义的句子，保持其他内容不变",
            "2. **保持格式**：维持原有的 Markdown 格式（标题层级、列表、代码块等）",
            "3. **增加细节**：用用户提供的详细信息替换模糊描述",
            "4. **移除标记**：删除所有 TODO、TBD、待定等临时标记",
            "5. **验证完整性**：确保更新后的章节逻辑完整、前后一致",
            "",
            "### 覆盖度摘要表格格式",
            "",
            "```markdown",
            "| 分类 | 状态 | 说明 |",
            "|------|------|------|",
            "| 功能范围与行为 | Clear | 核心目标和范围已明确定义 |",
            "| 领域与数据模型 | Resolved | Q1 已澄清实体关系 |",
            "| 交互与用户体验 | Deferred | 超出配额，建议在 plan 阶段处理 |",
            "| 非功能性质量属性 | Outstanding | 性能目标待定，但影响较低 |",
            "| ... | ... | ... |",
            "```",
        ])

        return "\n".join(guidelines)
