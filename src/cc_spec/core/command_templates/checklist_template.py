"""checklist 命令的模板实现。

该模板为 checklist 命令提供完整的执行指令，包括：
- 四维度打分系统（功能完整性、代码质量、测试覆盖、文档同步）
- 加权得分计算（40:25:25:10）
- 改进建议生成
- 打分报告输出
"""

from .base import CommandTemplate, CommandTemplateContext


class ChecklistTemplate(CommandTemplate):
    """checklist 命令的模板实现。

    该模板指导 AI 工具完成任务检查清单的四维度打分，包括：
    - 解析 tasks.yaml 中的检查清单
    - 按关键词分类到四个维度
    - 计算加权总分并判断通过状态
    - 生成改进建议和打分报告
    """

    def get_outline(self, ctx: CommandTemplateContext) -> str:
        """获取 checklist 命令的大纲描述。

        参数：
            ctx: 模板渲染上下文

        返回：
            大纲文本（Markdown 格式）
        """
        return """解析任务检查清单并计算四维度加权得分。

本命令负责评估任务完成质量，生成打分报告和改进建议：
- 读取 tasks.yaml 中的检查清单定义
- 根据关键词将检查项分类到四个维度
- 计算每个维度的得分率和加权总分
- 判断是否通过阈值（默认 ≥80 分）
- 为未通过维度生成具体改进建议
- 输出结构化的打分报告

**四个维度：**
- **功能完整性** (40%): 功能实现是否完整、需求是否满足
- **代码质量** (25%): 代码规范、lint 检查、重构质量
- **测试覆盖** (25%): 测试用例、覆盖率、集成测试
- **文档同步** (10%): 文档注释、类型标注、docstring

**关键原则：**
- 客观评分，基于事实而非主观判断
- 具体建议，每条建议必须可操作、可验证
- 全面覆盖，关注所有四个维度的均衡发展
"""

    def get_execution_steps(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 checklist 命令的执行步骤列表。

        参数：
            ctx: 模板渲染上下文

        返回：
            执行步骤列表
        """
        return [
            (
                "**读取并解析检查清单**：从 `.cc-spec/changes/{变更名称}/tasks.yaml` "
                "中读取所有任务的检查清单定义。解析每个检查项的状态：\n"
                "   - `[x]` 表示已完成（得 10 分）\n"
                "   - `[ ]` 表示未完成（得 0 分）\n"
                "   - `[-]` 表示已跳过（不计入总分）\n"
                "如果文件不存在或格式错误，报错并提示用户检查文件路径"
            ),
            (
                "**按关键词分类到四个维度**：根据检查项描述中的关键词，"
                "将每个检查项归类到对应维度：\n"
                "   - **功能完整性**：包含 '功能'、'实现'、'需求'、'feature'、"
                "'implement'、'create'、'add'\n"
                "   - **代码质量**：包含 '代码'、'规范'、'重构'、'quality'、"
                "'lint'、'refactor'、'style'、'ruff'、'mypy'\n"
                "   - **测试覆盖**：包含 '测试'、'test'、'覆盖'、'用例'、"
                "'coverage'、'unit'、'integration'、'pytest'\n"
                "   - **文档同步**：包含 '文档'、'注释'、'类型'、'doc'、"
                "'comment'、'type'、'docstring'\n"
                "   优先级顺序：测试覆盖 > 文档同步 > 代码质量 > 功能完整性（默认）"
            ),
            (
                "**计算每个维度的得分率**：对于每个维度，计算得分率 = "
                "(已完成检查项得分 / 该维度所有检查项满分) × 100%。"
                "跳过的检查项不计入分母。如果某个维度没有检查项，则该维度得分率视为 100%"
            ),
            (
                "**按权重计算加权总分**：使用以下权重计算加权总分：\n"
                "   - 功能完整性：40%\n"
                "   - 代码质量：25%\n"
                "   - 测试覆盖：25%\n"
                "   - 文档同步：10%\n"
                "   公式：总分 = Σ(维度得分率 × 维度权重) / Σ(有检查项的维度权重)\n"
                "   例如：如果只有功能完整性和代码质量有检查项，则总分 = "
                "(功能得分率 × 40 + 代码得分率 × 25) / (40 + 25)"
            ),
            (
                "**判断是否通过阈值**：将加权总分与通过阈值（默认 80 分）比较。"
                "如果总分 ≥ 阈值，标记为通过（PASSED）；否则标记为失败（FAILED）。"
                "同时识别所有得分率低于阈值的维度，标记为失败维度"
            ),
            (
                "**生成改进建议**：对于每个未通过的维度，生成具体的改进建议：\n"
                "   - 功能完整性：列出未完成的功能点，建议优先完成核心功能\n"
                "   - 代码质量：指出 lint 错误、类型检查问题，"
                "建议运行 `uv run ruff check --fix` 和 `uv run mypy`\n"
                "   - 测试覆盖：列出缺失的测试用例，建议补充单元测试和集成测试\n"
                "   - 文档同步：指出缺失的文档注释、类型标注，建议补充 docstring\n"
                "每条建议必须具体、可操作、可验证"
            ),
            (
                "**输出打分报告**：生成结构化的表格报告，包含：\n"
                "   - 各维度的得分率和权重\n"
                "   - 加权总分和通过状态\n"
                "   - 失败维度列表\n"
                "   - 改进建议（分维度列出）\n"
                "   - 下一步操作提示（如果失败，建议完成改进后重新运行 checklist；"
                "如果通过，建议运行 `cc-spec archive`）\n"
                "使用 Rich 表格格式输出，确保报告清晰、易读"
            ),
        ]

    def get_validation_checklist(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 checklist 命令完成后的验证检查清单。

        参数：
            ctx: 模板渲染上下文

        返回：
            验证项列表
        """
        return [
            "tasks.yaml 中的检查清单已正确解析（所有 [x]、[ ]、[-] 状态识别准确）",
            "检查项已按关键词正确分类到四个维度（功能、质量、测试、文档）",
            "各维度得分率计算正确（跳过的项不计入分母）",
            "加权总分计算正确（权重 40:25:25:10，公式应用准确）",
            "通过状态判断正确（总分 ≥80 为通过，< 80 为失败）",
            "改进建议具体可行（每条建议针对具体问题，可操作、可验证）",
            "打分报告格式清晰（使用 Rich 表格，包含所有必要信息）",
            "失败维度列表准确（所有得分率 <80 的维度均已标记）",
        ]

    def get_guidelines(self, ctx: CommandTemplateContext) -> str:
        """获取 checklist 命令的指南。

        参数：
            ctx: 模板渲染上下文

        返回：
            指南文本（Markdown 格式）
        """
        return """### 四维度打分系统详解（v1.3）

#### 1. 功能完整性 (FUNCTIONALITY) - 40%

**定义：** 评估功能实现的完整性和需求满足度。

**典型检查项：**
- ✅ 核心功能已实现（如"CommandTemplateContext 包含必要字段"）
- ✅ API 接口已定义（如"CommandTemplate 定义核心接口"）
- ✅ 功能点已完成（如"支持 markdown 和 toml 格式"）
- ✅ 需求已满足（如"变更名称符合格式要求"）

**关键词：** 功能、实现、需求、feature、implement、create、add、完成、支持

**权重理由：** 功能实现是任务的核心价值，权重最高（40%）

#### 2. 代码质量 (CODE_QUALITY) - 25%

**定义：** 评估代码规范性、可维护性和质量标准。

**典型检查项：**
- ✅ 代码通过 lint 检查（如"代码通过 ruff check"）
- ✅ 类型检查通过（如"代码通过 mypy 检查"）
- ✅ 代码规范符合项目标准（如"遵循命名规范"）
- ✅ 重构质量良好（如"避免重复代码"）

**关键词：** 代码、规范、重构、quality、lint、refactor、style、ruff、mypy、类型

**权重理由：** 代码质量直接影响可维护性，权重 25%

#### 3. 测试覆盖 (TEST_COVERAGE) - 25%

**定义：** 评估测试用例的完整性和覆盖率。

**典型检查项：**
- ✅ 单元测试已编写（如"单元测试覆盖主要逻辑"）
- ✅ 集成测试已完成（如"集成测试验证工作流"）
- ✅ 测试通过（如"所有测试通过 pytest"）
- ✅ 覆盖率达标（如"测试覆盖率 ≥80%"）

**关键词：** 测试、test、覆盖、用例、coverage、unit、integration、pytest

**权重理由：** 测试保证代码质量和稳定性，权重 25%

#### 4. 文档同步 (DOCUMENTATION) - 10%

**定义：** 评估文档、注释、类型标注的完整性。

**典型检查项：**
- ✅ 文档注释完整（如"所有公共 API 有 docstring"）
- ✅ 类型标注准确（如"所有函数有类型标注"）
- ✅ CLAUDE.md 已更新（如"项目文档同步更新"）
- ✅ README 已完善（如"使用说明清晰"）

**关键词：** 文档、注释、类型、doc、comment、type、docstring、标注

**权重理由：** 文档重要但不影响核心功能，权重最低（10%）

---

### 权重计算公式

**基础公式：**
```
加权总分 = Σ(维度得分率 × 维度权重) / Σ(有检查项的维度权重)
```

**示例 1：** 所有维度均有检查项
```
功能完整性：90% × 40 = 36
代码质量：  85% × 25 = 21.25
测试覆盖：  80% × 25 = 20
文档同步：  70% × 10 = 7
-------------------------------
总分 = (36 + 21.25 + 20 + 7) / (40 + 25 + 25 + 10) = 84.25 / 100 = 84.25
```

**示例 2：** 仅功能和代码质量有检查项
```
功能完整性：90% × 40 = 36
代码质量：  85% × 25 = 21.25
测试覆盖：  N/A（无检查项）
文档同步：  N/A（无检查项）
-------------------------------
总分 = (36 + 21.25) / (40 + 25) = 57.25 / 65 = 88.08
```

**注意：** 权重归一化确保即使某些维度缺失检查项，总分仍在 0-100 范围内。

---

### 关键词分类规则

#### 分类优先级

检查项按以下顺序匹配维度（先匹配先归类）：
1. **测试覆盖**（最高优先级）
2. **文档同步**
3. **代码质量**
4. **功能完整性**（默认，兜底）

**原因：** 测试和文档的关键词更专业、更明确，应优先匹配；
功能关键词较泛（如 '实现'、'完成'），作为默认分类。

#### 分类示例

```
"单元测试覆盖主要逻辑" → 测试覆盖（包含"测试"、"覆盖"）
"代码通过 ruff check" → 代码质量（包含"代码"、"ruff"）
"所有公共 API 有 docstring" → 文档同步（包含"docstring"）
"CommandTemplate 定义核心接口" → 功能完整性（无明确关键词，默认）
```

#### 多维度关键词处理

如果检查项同时包含多个维度的关键词，按优先级归类：
```
"实现测试用例并通过 pytest" → 测试覆盖（"测试"、"pytest"优先于"实现"）
"重构代码并补充注释" → 代码质量（"重构"、"代码"优先于"注释"）
```

---

### 改进建议格式规范

#### 原则

1. **具体**：明确指出问题所在，不使用泛泛而谈的描述
2. **可操作**：提供明确的操作步骤或命令
3. **可验证**：建议完成后可以通过测试或检查验证

#### 功能完整性建议示例

**❌ 差的建议：**
- "完善功能实现"
- "继续开发"

**✅ 好的建议：**
- "完成 ChecklistTemplate 类的 get_guidelines() 方法，补充四维度说明和权重计算公式"
- "实现 classify_items() 函数，添加关键词匹配逻辑"
- "修复 calculate_task_score() 函数，确保权重归一化计算正确"

#### 代码质量建议示例

**❌ 差的建议：**
- "提高代码质量"
- "改进代码规范"

**✅ 好的建议：**
- "运行 `uv run ruff check src/cc_spec/core/command_templates/checklist_template.py` "
  "修复 3 处 lint 错误"
- "运行 `uv run mypy src/cc_spec/core/` 修复类型标注问题（5 处 Any 类型需明确）"
- "重构 _classify_item() 函数，消除 12 行的重复代码"

#### 测试覆盖建议示例

**❌ 差的建议：**
- "补充测试"
- "提高覆盖率"

**✅ 好的建议：**
- "为 ChecklistTemplate 类编写单元测试（tests/test_checklist_template.py），覆盖 4 个核心方法"
- "补充 calculate_task_score() 的边界条件测试（空检查项、所有跳过、单维度等）"
- "运行 `uv run pytest --cov=src/cc_spec/core/command_templates` 确保覆盖率 ≥80%"

#### 文档同步建议示例

**❌ 差的建议：**
- "完善文档"
- "补充注释"

**✅ 好的建议：**
- "为 ChecklistTemplate 类的所有公共方法添加 docstring（遵循 Google 风格）"
- "在 CLAUDE.md 中更新 checklist 命令的使用说明和四维度打分机制"
- "为 get_execution_steps() 返回的每个步骤添加详细注释"

---

### 打分报告格式

#### 必需内容

1. **维度得分表格**：
   ```
   | 维度         | 得分率 | 权重 | 加权得分 |
   |-------------|-------|------|---------|
   | 功能完整性   | 90.0% | 40%  | 36.00   |
   | 代码质量     | 85.0% | 25%  | 21.25   |
   | 测试覆盖     | 80.0% | 25%  | 20.00   |
   | 文档同步     | 70.0% | 10%  | 7.00    |
   | **总分**    | —     | 100% | **84.25** |
   ```

2. **通过状态**：
   ```
   通过状态：✅ PASSED（总分 84.25 ≥ 80）
   ```
   或
   ```
   通过状态：❌ FAILED（总分 72.50 < 80）
   失败维度：代码质量 (65%)、测试覆盖 (60%)
   ```

3. **改进建议**（如果失败）：
   ```
   ## 改进建议

   ### 代码质量 (65%)
   - 运行 `uv run ruff check --fix src/` 修复 5 处 lint 错误
   - 运行 `uv run mypy src/cc_spec/core/` 修复类型标注问题

   ### 测试覆盖 (60%)
   - 补充 ChecklistTemplate 的单元测试
   - 运行 `uv run pytest --cov` 确保覆盖率 ≥80%
   ```

4. **下一步操作**：
   ```
   ## 下一步操作

   如果通过：运行 `cc-spec archive C-XXX` 归档变更
   如果失败：根据改进建议完成修改后，重新运行 `cc-spec checklist C-XXX`
   ```

---

### 常见陷阱与避免方法

#### 陷阱 1：关键词分类错误

**错误示例：**
```
"实现测试用例" → 功能完整性（❌ 应该是测试覆盖）
```

**正确做法：** 严格按优先级匹配，"测试"关键词应归类到测试覆盖维度

#### 陷阱 2：权重计算错误

**错误示例：**
```
总分 = (功能 90% + 代码 85% + 测试 80% + 文档 70%) / 4 = 81.25%
（❌ 未使用权重，简单平均）
```

**正确做法：** 必须使用加权平均：
```
总分 = (90×40 + 85×25 + 80×25 + 70×10) / 100 = 84.25%
```

#### 陷阱 3：跳过项处理错误

**错误示例：**
```
维度有 5 个检查项，其中 2 个 [x]、2 个 [ ]、1 个 [-]
得分率 = 2 / 5 = 40%（❌ 跳过项不应计入分母）
```

**正确做法：**
```
得分率 = 2 / (5-1) = 50%（跳过项从分母中排除）
```

#### 陷阱 4：改进建议过于笼统

**错误示例：**
- "提高代码质量"（❌ 无具体操作）
- "补充测试"（❌ 无明确范围）

**正确做法：**
- "运行 `uv run ruff check --fix` 修复 3 处 lint 错误"
- "为 ChecklistTemplate 类编写单元测试，覆盖 4 个核心方法"

---

### 权重调整（高级用法）

虽然默认权重是 40:25:25:10，但用户可以在 `.cc-spec/config.yaml` 中自定义权重：

```yaml
scoring:
  pass_threshold: 80
  dimensions:
    functionality:
      weight: 30  # 调整为 30%
    code_quality:
      weight: 30  # 调整为 30%
    test_coverage:
      weight: 30  # 调整为 30%
    documentation:
      weight: 10  # 保持 10%
```

**注意：** 权重总和应为 100，但代码会自动归一化，因此不强制要求。
"""
