"""Checklist 命令模板。

该模板为 checklist 命令生成完整的 AI 工作流指令，用于：
1. 解析任务清单中的检查项（支持 [x], [ ], [-] 三种状态）
2. 执行四维度打分（功能完整性、代码质量、测试覆盖、文档同步）
3. 生成详细的打分报告和改进建议
"""

from .base import CommandTemplate, CommandTemplateContext


class ChecklistTemplate(CommandTemplate):
    """Checklist 命令的完整模板。

    该模板遵循 cc-spec v0.1.4 的四源融合设计，整合：
    - 四维度打分机制（功能、质量、测试、文档，均等权重 25%）
    - 加权计算公式和阈值判定（默认 ≥80%）
    - 详细的改进建议生成
    """

    def get_outline(self, ctx: CommandTemplateContext) -> str:
        """获取 checklist 命令的大纲描述。

        参数：
            ctx: 模板渲染上下文

        返回：
            大纲文本（Markdown 格式）
        """
        return """验证任务完成质量，使用四维度打分系统评估任务清单。

**核心功能**:
1. 解析 `tasks.md` 中的检查项（[x] 完成，[ ] 未完成，[-] 跳过）
2. 按四个维度分类检查项：功能完整性、代码质量、测试覆盖、文档同步
3. 计算加权总分和各维度得分（均等权重 25%）
4. 判断是否通过阈值（默认 80%）
5. 生成详细报告和针对性改进建议

**四个维度（均等权重 25%）**:
- **功能完整性**: 核心功能是否实现、业务逻辑是否完整
- **代码质量**: 代码规范、架构设计、可维护性
- **测试覆盖**: 单元测试、集成测试、边界情况
- **文档同步**: API 文档、注释、README 更新

**加权计算公式**:
```
总分 = Σ(维度得分率 × 维度权重) / Σ(有效维度权重)
维度得分率 = (已完成项分数) / (总项分数) × 100%
```

**通过条件**: 总分 >= 80%（各维度独立评估）
"""

    def get_execution_steps(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 checklist 命令的执行步骤列表。

        参数：
            ctx: 模板渲染上下文

        返回：
            执行步骤列表
        """
        return [
            "**验证环境**: 确认在 `.cc-spec/changes/<change-name>/` 目录中有 `tasks.md` 文件",

            "**解析检查项**: 从 `tasks.md` 提取所有任务的检查清单，支持三种状态：\n"
            "   - `[x]` 已完成（得 10 分）\n"
            "   - `[ ]` 未完成（得 0 分）\n"
            "   - `[-]` 已跳过（不计入总分和满分）\n"
            "   示例格式:\n"
            "   ```markdown\n"
            "   ### W1-T1 - 任务标题\n"
            "   **Checklist**:\n"
            "   - [x] 实现核心功能\n"
            "   - [ ] 添加单元测试\n"
            "   - [-] 性能优化（跳过）\n"
            "   ```",

            "**四维度分类**: 根据检查项描述的关键词，将每个检查项归类到对应维度\n"
            "   - **测试覆盖**（最高优先级）: 包含 '测试'、'test'、'覆盖'、'coverage'、\n"
            "     'pytest'、'单元'、'集成'\n"
            "   - **文档同步**: 包含 '文档'、'doc'、'注释'、'comment'、'README'、\n"
            "     'docstring'、'类型标注'\n"
            "   - **代码质量**: 包含 '代码'、'质量'、'规范'、'lint'、'ruff'、'mypy'、\n"
            "     '重构'、'优化'\n"
            "   - **功能完整性**（默认）: 包含 '功能'、'实现'、'完成'、'feature'、\n"
            "     'implement'、'add'\n"
            "   **分类规则**: 按优先级顺序匹配，先匹配者归类；无匹配时默认归类到功能完整性",

            "**计算维度得分**: 对每个任务的每个维度计算得分率\n"
            "   - 过滤跳过项（[-] 不计入）\n"
            "   - 维度得分 = 完成数 × 10\n"
            "   - 维度满分 = （总项数 - 跳过数）× 10\n"
            "   - 维度得分率 = (维度得分 / 维度满分) × 100%\n"
            "   - 无检查项的维度: 得分率 = 100%（视为通过）",

            "**计算加权总分**: 按均等权重（25% × 4）计算任务总分\n"
            "   - 只计算有检查项的维度（max_score > 0）\n"
            "   - 加权和 = Σ(维度得分率 × 25)\n"
            "   - 总权重 = 有效维度数 × 25\n"
            "   - 任务总分 = 加权和 / 总权重\n"
            "   示例: 功能 80%、质量 100%、测试 90%、文档无检查项\n"
            "   → 总分 = (80×25 + 100×25 + 90×25) / (25+25+25) = 90%",

            "**判断通过状态**: 检查任务和维度是否达标\n"
            "   - 任务通过: 总分 >= 80%\n"
            "   - 维度失败: 记录得分率 < 80% 的维度\n"
            "   - 整体通过: 所有任务总分的平均值 >= 80%",

            "**汇总维度得分**: 跨任务累加各维度的得分和满分\n"
            "   - 对每个维度: 汇总得分 = Σ(所有任务该维度得分)\n"
            "   - 对每个维度: 汇总满分 = Σ(所有任务该维度满分)\n"
            "   - 维度汇总得分率 = (汇总得分 / 汇总满分) × 100%",

            "**生成改进建议**: 根据失败维度生成针对性建议\n"
            "   - 统计各维度失败次数\n"
            "   - 输出 '有 N 个任务在 [维度名] 维度未达标'\n"
            "   - 测试不足: '建议: 补充单元测试和集成测试'\n"
            "   - 文档缺失: '建议: 更新文档和代码注释'\n"
            "   - 质量问题: '建议: 运行 lint 检查并修复代码风格问题'",

            "**生成打分报告**: 输出 Markdown 格式报告，包含:\n"
            "   - 整体信息（阈值、总分、状态）\n"
            "   - 任务总览表格（任务 ID、总分、四维度得分、状态）\n"
            "   - 维度汇总表格（维度名、权重、汇总得分、状态）\n"
            "   - 改进建议列表\n"
            "   - 失败报告（如果未通过，展开显示各任务的未完成项）",

            "**保存和显示**: 保存报告到 `.cc-spec/changes/<change-name>/checklist-report.md`\n"
            "   并使用 Rich 库在控制台展示格式化结果",
        ]

    def get_validation_checklist(self, ctx: CommandTemplateContext) -> list[str]:
        """获取 checklist 命令完成后的验证检查清单。

        参数：
            ctx: 模板渲染上下文

        返回：
            验证项列表
        """
        return [
            "tasks.md 中的检查清单已正确解析（所有 [x]、[ ]、[-] 状态识别准确）",
            "检查项已按关键词正确分类到四个维度（测试 > 文档 > 质量 > 功能优先级）",
            "各维度得分率计算正确（跳过项不计入分母，无检查项视为 100%）",
            "加权总分计算正确（均等权重 25%，只包含有检查项的维度）",
            "整体得分是所有任务总分的平均值",
            "维度汇总正确（跨任务累加各维度得分和满分）",
            "改进建议根据失败维度正确生成（具体、可操作）",
            "报告包含所有必需部分：总览表格、维度汇总、改进建议",
            "如果未通过，失败报告详细列出所有未完成项",
            "报告已保存到 checklist-report.md，控制台使用 Rich 格式化显示",
        ]

    def get_guidelines(self, ctx: CommandTemplateContext) -> str:
        """获取 checklist 命令的指南。

        参数：
            ctx: 模板渲染上下文

        返回：
            指南文本（Markdown 格式）
        """
        return """### 四维度说明（均等权重 25%）

**1. 功能完整性 (Functionality)**
- 核心功能是否按需求实现
- 业务逻辑是否完整
- API 接口是否正确
- 用户需求是否满足
- 关键词: 功能、实现、完成、需求、feature、implement、add、create

**2. 代码质量 (Code Quality)**
- 代码是否符合规范（PEP 8, ESLint 等）
- 架构设计是否合理
- 可读性和可维护性
- 类型注解是否完整
- 是否有代码坏味道
- 关键词: 代码、质量、规范、lint、ruff、mypy、重构、优化

**3. 测试覆盖 (Test Coverage)**
- 单元测试是否充分
- 集成测试是否覆盖关键流程
- 边界情况和异常处理是否测试
- 测试覆盖率是否达标
- 关键词: 测试、test、覆盖、coverage、pytest、单元、集成、用例

**4. 文档同步 (Documentation)**
- API 文档是否更新
- README 是否同步
- 代码注释是否清晰
- 变更日志是否记录
- 关键词: 文档、doc、注释、comment、README、docstring、类型标注

---

### 权重计算公式

**单任务得分**:
```
任务总分 = Σ(维度得分率 × 25) / Σ(有效维度数 × 25)
```

**示例**: 任务 W1-T1 检查项分布
- 功能完整性: 5 项（4 完成，1 未完成）→ 80%
- 代码质量: 3 项（3 完成）→ 100%
- 测试覆盖: 2 项（1 完成，1 跳过）→ 100%（跳过不计入）
- 文档同步: 0 项 → 不参与计算

计算:
```
加权和 = (80×25) + (100×25) + (100×25) = 70
总权重 = 25 + 25 + 25 = 75
任务总分 = 70 / 75 = 93.3%
```

**整体得分**: 所有任务总分的平均值
**维度汇总**: Σ(该维度所有任务得分) / Σ(该维度所有任务满分) × 100%

---

### 改进建议格式

改进建议应针对具体问题，提供可操作的指导：

**统计型**: "有 N 个任务在 [维度名] 维度未达标"
**测试型**: "建议: 补充单元测试和集成测试"
**文档型**: "建议: 更新文档和代码注释"
**质量型**: "建议: 运行 lint 检查并修复代码风格问题"

示例:
```markdown
## 改进建议

- 有 2 个任务在功能完整性维度未达标
- 有 1 个任务在测试覆盖维度未达标
- 建议: 补充单元测试和集成测试
```

---

### 注意事项

1. **跳过项处理**: [-] 标记的检查项不计入总分和满分，但在报告中显示
2. **无检查项维度**: 如果某维度没有检查项，得分视为 100%，不参与权重计算
3. **阈值灵活性**: 默认阈值 80%，可通过 config.yaml 调整
4. **精度控制**: 百分比保留一位小数，总分显示为整数
5. **报告可读性**: 使用 Markdown 表格、加粗标记、符号（√ ×）提高可读性
"""
