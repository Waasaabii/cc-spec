# 02 - 现状分析

本文档精确到文件/类/函数/行号，分析 v0.1.3 各模块的当前实现状态。

---

## 2.1 命令文件生成器

### 文件位置
`src/cc_spec/core/command_generator.py`

### 当前实现

| 函数/类 | 行号 | 功能 | 问题 |
|---------|------|------|------|
| `_get_md_content()` | 160-182 | 生成 Markdown 命令内容 | 只有 ~20 行，缺失完整工作流 |
| `_get_toml_content()` | 184-201 | 生成 TOML 命令内容 | 只有 ~15 行，缺失完整工作流 |
| `CC_SPEC_COMMANDS` | 17-28 | 命令列表定义 | 缺少详细描述 |
| `COMMAND_GENERATORS` | 402-422 | 生成器注册表 | 17+ 工具支持 ✅ |

### 核心问题代码
```python
# src/cc_spec/core/command_generator.py:160-182
def _get_md_content(self, cmd_name: str, description: str) -> str:
    return f"""---
description: {description}
allowed-tools: Bash, Read, Write, Edit, Glob, Grep
---

{MANAGED_START}
## 工作流: cc-spec {cmd_name}

用户请求: $ARGUMENTS

**执行步骤**:
1. 解析用户参数
2. 运行 `cc-spec {cmd_name} $ARGUMENTS`
3. 显示结果并建议下一步操作
{MANAGED_END}
"""
```

### 参考设计（Spec-Kit）
`reference/test-project/speckitProject/.codex/prompts/speckit.specify.md` (259 行)

---

## 2.2 clarify 命令

### 文件位置
`src/cc_spec/commands/clarify.py`

### 当前实现

| 函数 | 行号 | 功能 | 问题 |
|------|------|------|------|
| `show_task_list()` | 65-101 | 显示任务列表 | ✅ 已实现 |
| `rework_task()` | 104-179 | 标记任务返工 | ✅ 已实现 |
| `clarify()` | 182-278 | 主命令函数 | ❌ 缺少歧义检测 |

### 缺失功能
当前实现只有任务列表显示和返工标记，缺少 Spec-Kit 的 **9 大歧义分类检测**：

```yaml
# 设计要求（未实现）
九大歧义分类:
  1. Scope - 范围边界不清
  2. Data - 数据结构/格式未定义
  3. Interface - 接口契约模糊
  4. Behavior - 行为逻辑有歧义
  5. Security - 安全/权限未明确
  6. Performance - 性能指标缺失
  7. ErrorHandling - 错误处理方式
  8. Integration - 集成点未定义
  9. Priority - 优先级/顺序未排
```

---

## 2.3 specify 命令

### 文件位置
`src/cc_spec/commands/specify.py`

### 当前实现

| 函数 | 行号 | 功能 | 问题 |
|------|------|------|------|
| `validate_change_name()` | 44-65 | 校验变更名称 | ✅ 已实现 |
| `_create_new_change()` | 156-257 | 创建新变更 | ❌ 只复制模板 |
| `_edit_existing_change()` | 112-153 | 编辑已有变更 | ✅ 已实现 |
| `specify()` | 68-109 | 主命令函数 | ❌ 缺少智能分析 |

### 缺失功能
```yaml
# 设计要求（未实现）
智能代码分析:
  - 扫描项目结构识别技术栈
  - 分析现有代码模式和约定

Git 分支管理:
  - 检测 remote/local/specs 最高编号
  - 创建 {N+1}-{short-name} 分支
  - 切换到新分支

规范验证检查清单:
  - 创建 requirements.md checklist
  - 验证规范质量
  - 处理 [NEEDS CLARIFICATION] 标记
```

---

## 2.4 plan 命令

### 文件位置
`src/cc_spec/commands/plan.py`

### 当前实现

| 函数 | 行号 | 功能 | 问题 |
|------|------|------|------|
| `plan_command()` | 31-211 | 主命令函数 | ❌ 只复制模板 |
| `_create_basic_tasks_md()` | 214-270 | 创建基础 tasks.md | ❌ 结构简陋 |
| `_create_basic_design_md()` | 273-338 | 创建基础 design.md | ❌ 结构简陋 |
| `_validate_tasks_dependencies()` | 341-396 | 校验依赖关系 | ✅ 基础实现 |

### 缺失功能
```yaml
# 设计要求（未实现）
九段大纲:
  1. 背景与目标
  2. 现状（精确到文件/类/函数/行号）
  3. 缺口
  4. 设计与对接方案
  5. 实施步骤
  6. 测试与验收
  7. 风险与依赖
  8. 里程碑
  9. 附录

Phase 0/1 流程:
  Phase 0 (Research): 读取现有代码、分析依赖、识别复用点
  Phase 1 (Design): data-model、contracts、生成 tasks.md

Gate/Wave 并行规划:
  - 每个 Task 必须写依赖、必读文档、测试文件、预估行数
  - 关键路径文件锁优先级
```

---

## 2.5 checklist 打分

### 文件位置
`src/cc_spec/core/scoring.py`

### 当前实现

| 函数/类 | 行号 | 功能 | 状态 |
|---------|------|------|------|
| `CheckItem` | 24-42 | 检查项数据类 | ✅ 已实现 |
| `DimensionScore` | 72-90 | 维度得分（v1.3） | ✅ 已实现 |
| `TaskScore` | 93-112 | 任务得分（v1.3） | ✅ 已实现 |
| `ChecklistResult` | 114-134 | 完整结果（v1.3） | ✅ 已实现 |
| `parse_checklist()` | 141-189 | 解析检查项 | ✅ 已实现 |
| `_classify_item()` | 324-363 | 关键词分类到维度 | ✅ 已实现 |
| `calculate_task_score()` | 443-513 | 四维度加权计算 | ✅ 已实现 |

### 问题
数据结构已实现，但 **checklist 命令未完整使用**。需要在 `commands/checklist.py` 中调用
`calculate_checklist_result()`。

---

## 2.6 SubAgent 执行器

### 文件位置
`src/cc_spec/subagent/executor.py`

### 当前实现

| 函数/类 | 行号 | 功能 | 状态 |
|---------|------|------|------|
| `ExecutionResult` | 39-68 | 执行结果数据类 | ✅ 含 agent_id/wave/retry_count |
| `SubAgentExecutor.__init__()` | 90-146 | 初始化 | ✅ 含 LockManager |
| `execute_task()` | 272-381 | 执行单个任务 | ⚠️ 模拟实现 |
| `_execute_task_with_lock()` | 383-451 | 带锁执行 | ✅ 已实现 |
| `execute_wave()` | 453-555 | 执行 Wave | ✅ 已实现 |
| `execute_all()` | 557-604 | 执行所有 Wave | ✅ 已实现 |

### 问题
`execute_task()` 第 319-321 行是**模拟实现**，需要集成真实 Claude Code SubAgent 执行。

---

## 2.7 apply 命令

### 文件位置
`src/cc_spec/commands/apply.py`

### 当前实现

| 函数 | 行号 | 功能 | 状态 |
|------|------|------|------|
| `apply_command()` | 51-323 | 主命令函数 | ✅ 基本实现 |
| `_execute_with_progress()` | 326-427 | 带进度执行 | ✅ 已实现 |
| `_display_task_summary()` | 430-462 | 显示任务摘要 | ✅ 已实现 |

### 缺失功能
```yaml
# 设计要求（未实现）
技术硬要求统一执行:
  - 所有 SubAgent 完成后
  - 主 Agent 统一执行 lint/type-check/test
  - 从 CLAUDE.md 读取检查命令（不硬编码）
  - 结果影响 checklist 打分
```

---

## 2.8 模板文件

### 文件位置
`src/cc_spec/templates/`

### 当前状态

| 模板 | 行数 | 问题 |
|------|------|------|
| `spec-template.md` | 116 | ❌ 缺少用户故事优先级、独立测试说明 |
| `checklist-template.md` | 41 | ⚠️ 示例结构，需根据任务动态生成 |
| `plan-template.md` | - | ❌ 缺少九段大纲 |
| `tasks-template.md` | - | ⚠️ 基础结构，缺少详细字段 |

---

## 现状总结

### ✅ 已完整实现
- 17+ AI 工具命令生成器框架
- ID 系统（C-001/S-001/A-001）
- Delta 变更追踪
- Git 分布式锁（LockManager）
- 四维度打分数据结构
- SubAgent 并发执行框架
- Wave/Task 任务解析

### ⚠️ 部分实现
- checklist 命令（数据结构有，命令未完整使用）
- SubAgent 执行（框架有，真实执行是模拟）
- 模板文件（基础结构，内容不完整）

### ❌ 完全缺失
- 命令文件完整工作流指令
- clarify 9 大歧义分类检测
- specify 智能代码分析
- plan 九段大纲和 Phase 0/1 流程
- 技术硬要求主 Agent 统一执行