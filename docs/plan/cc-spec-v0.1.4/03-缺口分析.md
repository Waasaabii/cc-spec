# 03 - 缺口分析

本文档列点分析当前实现与四源融合设计的具体缺口，禁止笼统表述。

---

## 缺口汇总表

| 编号 | 缺口 | 来源 | 严重程度 | 影响范围 |
|------|------|------|----------|----------|
| G-01 | 命令文件内容简陋 | Spec-Kit | 🔴 严重 | 所有 AI 工具命令 |
| G-02 | clarify 缺少歧义检测 | Spec-Kit | 🔴 严重 | 需求澄清流程 |
| G-03 | specify 缺少智能分析 | OpenSpec | 🔴 严重 | 工作流起点 |
| G-04 | plan 缺少九段大纲 | DOCUMENTATION-GUIDELINES | 🟡 中等 | 规划质量 |
| G-05 | checklist 未使用四维度 | Spec-Kit | 🟡 中等 | 验收精度 |
| G-06 | 技术硬要求未统一执行 | DOCUMENTATION-GUIDELINES | 🟡 中等 | 质量保障 |
| G-07 | 模板内容不完整 | 综合 | 🟡 中等 | 文档生成 |

---

## G-01: 命令文件内容简陋

### 当前状态
- 文件：`src/cc_spec/core/command_generator.py:160-182`
- 内容：每个命令只有 ~20 行简单 CLI 调用包装
- 问题：缺失完整工作流指令，AI 工具无法自主执行复杂流程

### 设计要求
- 参考：`reference/test-project/speckitProject/.codex/prompts/speckit.specify.md` (259 行)
- 每个命令应包含：
  - 详细执行步骤（7+ 步骤）
  - Git 分支检查和创建逻辑
  - 模板加载和变量替换
  - 验证检查清单
  - 错误处理和回退逻辑
  - `[NEEDS CLARIFICATION]` 标记处理
  - 表格格式的选项呈现

### 缺口详情
```diff
- 当前: 3 步骤（解析参数 → 运行命令 → 显示结果）
+ 设计: 7+ 步骤（完整工作流指令）

- 当前: 无 Git 分支管理

- 当前: 无验证检查清单
+ 设计: 生成 requirements.md → 运行验证 → 处理失败项

- 当前: 无歧义处理
+ 设计: 提取 [NEEDS CLARIFICATION] → 呈现选项表格 → 等待用户回答
```

---

## G-02: clarify 缺少歧义检测

### 当前状态
- 文件：`src/cc_spec/commands/clarify.py:182-278`
- 功能：只有任务列表显示和返工标记
- 问题：缺少自动扫描和分类歧义的能力

### 设计要求
- 参考：Spec-Kit clarify 流程
- 9 大歧义分类：
  1. **Scope** - 范围边界不清
  2. **Data** - 数据结构/格式未定义
  3. **Interface** - 接口契约模糊
  4. **Behavior** - 行为逻辑有歧义
  5. **Security** - 安全/权限未明确
  6. **Performance** - 性能指标缺失
  7. **ErrorHandling** - 错误处理方式
  8. **Integration** - 集成点未定义
  9. **Priority** - 优先级/顺序未排

### 缺口详情
```diff
- 当前: 无歧义检测
+ 设计: 扫描 proposal.md/spec.md → 识别模糊措辞 → 分类歧义

- 当前: 无关键词匹配
+ 设计: 关键词列表（"可能"、"视情况"、"待定"、"TBD"）

- 当前: 无澄清问题生成
```

---

## G-03: specify 缺少智能分析

### 当前状态
- 文件：`src/cc_spec/commands/specify.py:156-257`
- 功能：只创建目录和复制模板
- 问题：无法感知项目上下文，无法智能生成规范内容

### 设计要求
- 参考：OpenSpec 智能代码分析
- 功能要求：
  - 扫描项目结构识别技术栈
  - 分析现有代码模式和约定
  - 提取可复用的组件/函数
  - 生成技术上下文摘要

### 缺口详情
```diff
- 当前: 无项目扫描
+ 设计: 检测 pyproject.toml/package.json → 识别技术栈

+ 设计: 检查是否有现有代码 → 判断项目类型

- 当前: 无 Git 分支管理

- 当前: 无规范验证
+ 设计: 生成 requirements.md → 验证规范质量
```

---

## G-04: plan 缺少九段大纲

### 当前状态
- 文件：`src/cc_spec/commands/plan.py:214-338`
- 功能：只生成基础 tasks.md 和 design.md
- 问题：结构简陋，缺少 DOCUMENTATION-GUIDELINES 要求的完整大纲

### 设计要求
- 参考：`reference/DOCUMENTATION-GUIDELINES.md`
- 九段大纲：
  1. 背景与目标
  2. 现状（精确到文件/类/函数/行号）
  3. 缺口
  4. 设计与对接方案（API 契约、数据表、ENV 配置）
  5. 实施步骤（标注可并行/需串行）
  6. 测试与验收（测试文件路径、命令、耗时预估）
  7. 风险与依赖
  8. 里程碑
  9. 附录（必读文件、改动行数、单文件<500 行约束）

### 缺口详情
```diff
- 当前: 简单的 tasks.md 结构
+ 设计: 完整九段大纲

- 当前: 无 Phase 0/1 流程
+ 设计: Phase 0 (Research) → Phase 1 (Design)

- 当前: 无 Gate/Wave 自动规划
```

---

## G-05: checklist 未使用四维度

### 当前状态
- 文件：`src/cc_spec/core/scoring.py:443-513` (数据结构已实现)
- 文件：`src/cc_spec/commands/checklist.py` (命令未完整使用)
- 问题：四维度打分数据结构已存在，但命令未调用

### 设计要求
- 四维度加权：
  - 功能完整性：30%
  - 代码质量：25%
  - 测试覆盖：25%
  - 文档同步：20%

### 缺口详情
```diff
- 当前: 简单勾选计分（每项 10 分等权重）
+ 设计: 四维度加权计分

- 当前: 命令未调用 calculate_checklist_result()
+ 设计: 使用完整的四维度打分流程

- 当前: 无维度报告
+ 设计: 生成维度汇总表格和改进建议
```

---

## G-06: 技术硬要求未统一执行

### 当前状态
- 文件：`src/cc_spec/core/config.py:203-208` (配置来源已定义)
- 问题：未实现统一执行逻辑

### 设计要求
- 执行时机：所有 SubAgent 完成后，主 Agent 统一执行
- 命令来源：从 CLAUDE.md 读取（不硬编码）
- 智能识别：如未配置，根据技术栈自动判断

### 缺口详情
```diff
- 当前: 只有配置来源列表
+ 设计: 读取 CLAUDE.md → 提取检查命令

- 当前: 无智能识别

- 当前: 无统一执行
+ 设计: 主 Agent 统一执行（不是每个 SubAgent 单独跑）

- 当前: 结果未影响打分
+ 设计: 检查结果纳入 checklist 打分维度
```

---

## G-07: 模板内容不完整

### 当前状态
- 目录：`src/cc_spec/templates/`
- 问题：模板结构简陋，缺少详细字段

### 缺口详情

#### spec-template.md
```diff
- 当前: 基础 User Story 结构
+ 设计: 增加优先级（P1/P2/P3）、独立测试说明、Why this priority
```

#### checklist-template.md
```diff
- 当前: 示例结构
+ 设计: 动态生成，包含四维度分类标记
```

#### plan-template.md
```diff
- 当前: 基础结构
+ 设计: 九段大纲完整模板
```

#### tasks-template.md
```diff
- 当前: 简单概览表
+ 设计: 完整字段（Profile、agent_id、started_at、completed_at、retry_count）
```

---

## 缺口优先级排序

### P0 - 必须修复（阻塞核心功能）
1. **G-01** 命令文件内容简陋
2. **G-03** specify 缺少智能分析

### P1 - 应该修复（影响用户体验）
3. **G-02** clarify 缺少歧义检测
4. **G-04** plan 缺少九段大纲

### P2 - 可以修复（提升质量）
5. **G-05** checklist 未使用四维度
6. **G-06** 技术硬要求未统一执行
7. **G-07** 模板内容不完整