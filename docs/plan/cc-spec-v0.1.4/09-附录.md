# 09 - 附录

本文档包含必读上下文文件列表、预计改动行数、单文件约束和强制命令清单。

---

## A. 必读上下文文件列表

### 核心代码文件

| 文件路径 | 行数 | 重要行号 | 说明 |
|----------|------|----------|------|
| `src/cc_spec/core/command_generator.py` | 447 | 160-182, 184-201 | 命令生成核心 |
| `src/cc_spec/commands/clarify.py` | 278 | 65-101, 182-278 | clarify 命令 |
| `src/cc_spec/commands/specify.py` | 258 | 68-109, 156-257 | specify 命令 |
| `src/cc_spec/commands/plan.py` | 456 | 31-211, 214-338 | plan 命令 |
| `src/cc_spec/commands/apply.py` | 685 | 51-323, 326-427 | apply 命令 |
| `src/cc_spec/core/scoring.py` | 917 | 324-363, 443-513 | 打分机制 |
| `src/cc_spec/subagent/executor.py` | 698 | 272-381, 383-451 | SubAgent 执行 |
| `src/cc_spec/core/config.py` | 405 | 203-208 | 配置管理 |

### 参考设计文件

| 文件路径 | 说明 |
|----------|------|
| `reference/test-project/speckitProject/.codex/prompts/speckit.specify.md` | Spec-Kit 命令示例 |
| `reference/test-project/speckitProject/.claude/commands/speckit.specify.md` | Spec-Kit Claude 命令 |
| `reference/DOCUMENTATION-GUIDELINES.md` | 九段大纲规范 |
| `reference/历史聊天/12488661-ea75-42fd-8cf8-7541721d75a3.md` | 四源融合设计讨论 |

### 模板文件

| 文件路径 | 行数 | 说明 |
|----------|------|------|
| `src/cc_spec/templates/spec-template.md` | 116 | 规范模板 |
| `src/cc_spec/templates/checklist-template.md` | 41 | 检查清单模板 |

---

## B. 预计改动行数

### 新增文件

| 文件路径 | 预估行数 |
|----------|----------|
| `src/cc_spec/core/command_templates/__init__.py` | ~20 |
| `src/cc_spec/core/command_templates/base.py` | ~120 |
| `src/cc_spec/core/command_templates/specify_template.py` | ~280 |
| `src/cc_spec/core/command_templates/clarify_template.py` | ~220 |
| `src/cc_spec/core/command_templates/plan_template.py` | ~300 |
| `src/cc_spec/core/command_templates/apply_template.py` | ~240 |
| `src/cc_spec/core/command_templates/checklist_template.py` | ~200 |
| `src/cc_spec/core/ambiguity/__init__.py` | ~10 |
| `src/cc_spec/core/ambiguity/detector.py` | ~250 |
| `src/cc_spec/core/tech_check/__init__.py` | ~10 |
| `src/cc_spec/core/tech_check/reader.py` | ~100 |
| `src/cc_spec/core/tech_check/detector.py` | ~80 |
| `src/cc_spec/core/tech_check/runner.py` | ~60 |
| `src/cc_spec/templates/proposal-template.md` | ~50 |
| `.cc-spec/templates/setup-checklist.md` | ~20 |
| `.cc-spec/templates/feature-checklist.md` | ~25 |
| `.cc-spec/templates/test-checklist.md` | ~20 |
| **新增文件小计** | **~2005** |

### 修改文件

| 文件路径 | 预估净增行数 |
|----------|--------------|
| `src/cc_spec/core/command_generator.py` | ~50 (重构) |
| `src/cc_spec/commands/clarify.py` | ~100 |
| `src/cc_spec/commands/apply.py` | ~210 |
| `src/cc_spec/commands/init.py` | ~80 |
| `src/cc_spec/commands/specify.py` | ~50 |
| `src/cc_spec/commands/plan.py` | ~100 |
| `src/cc_spec/subagent/task_parser.py` | ~80 |
| `src/cc_spec/subagent/executor.py` | ~50 |
| `src/cc_spec/core/templates.py` | ~30 |
| **修改文件小计** | **~750** |

### 测试文件

| 文件路径 | 预估行数 |
|----------|----------|
| `tests/core/test_command_templates.py` | ~200 |
| `tests/core/test_ambiguity.py` | ~150 |
| `tests/core/test_tech_check.py` | ~120 |
| `tests/core/test_single_source.py` | ~80 |
| `tests/core/test_tasks_yaml.py` | ~100 |
| `tests/integration/test_specify_workflow.py` | ~100 |
| `tests/integration/test_clarify_detection.py` | ~80 |
| `tests/integration/test_apply_tech_check.py` | ~80 |
| `tests/integration/test_context_optimize.py` | ~100 |
| **测试文件小计** | **~1010** |

### 总计

| 类别 | 行数 |
|------|------|
| 新增源码 | ~2005 |
| 修改源码 | ~750 |
| 测试代码 | ~1010 |
| **总计** | **~3765** |

---

## C. 单文件 <500 行约束

### 约束检查

所有新增文件必须遵守单文件 <500 行约束：

| 文件 | 预估行数 | 状态 |
|------|----------|------|
| `command_templates/base.py` | ~120 | ✅ |
| `command_templates/specify_template.py` | ~280 | ✅ |
| `command_templates/clarify_template.py` | ~220 | ✅ |
| `command_templates/plan_template.py` | ~300 | ✅ |
| `command_templates/apply_template.py` | ~240 | ✅ |
| `command_templates/checklist_template.py` | ~200 | ✅ |
| `ambiguity/detector.py` | ~250 | ✅ |
| `tech_check/reader.py` | ~100 | ✅ |
| `tech_check/detector.py` | ~80 | ✅ |
| `tech_check/runner.py` | ~60 | ✅ |

### 拆分方案

如果任何文件超过 500 行，按以下方式拆分：

- `command_templates/` 已按命令拆分
- `ambiguity/` 可拆分为 `detector.py` + `classifier.py` + `question_generator.py`
- `tech_check/` 已按功能拆分

---

## D. 强制命令清单

### 开发阶段必须运行

```bash
# Lint 检查
uv run ruff check src/

# 类型检查
uv run mypy src/cc_spec/

# 单元测试
uv run pytest tests/core/ tests/commands/ -v

# 集成测试
uv run pytest tests/integration/ -v
```

### 提交前必须运行

```bash
# 完整测试套件
uv run pytest --cov=cc_spec --cov-report=term-missing

# 格式检查
uv run ruff format --check src/

# 或自动格式化
uv run ruff format src/
```

### 发布前必须运行

```bash
# 构建检查
uv build

# 安装测试
pip install dist/cc_spec-0.1.4-py3-none-any.whl
cc-spec --version

# 基本功能验证
cc-spec --help
cc-spec init --help
cc-spec specify --help
```

---

## E. 变更日志草稿

```markdown
## [0.1.4] - 四源融合 + 单一真相源

### Added
- 命令模板系统：每个命令生成 150-300 行完整工作流指令
- 歧义检测器：支持 9 大歧义分类自动检测（含上下文判断）
- 技术检查模块：从 CLAUDE.md 读取或智能检测技术栈
- clarify 命令新增 `--detect` 选项
- apply 命令新增主 Agent 统一技术检查
- init 命令完成后显示中文配置提示
- 单一真相源：合并 proposal.md + design.md
- 结构化任务：tasks.yaml 替代 tasks.md（体积 -80%）
- SubAgent 上下文优化（从 ~5K 降到 ~500 tokens/agent）
- 公共模板引用机制（$templates/）

### Changed
- 重构 command_generator.py 使用模板系统
- checklist 命令使用完整的四维度打分
- plan 命令生成 tasks.yaml 而非 tasks.md
- apply 命令预处理上下文后再分发给 SubAgent

### Fixed
- 修复命令文件内容过于简陋的问题
- 修复歧义检测误报问题（增加上下文判断）

### Dependencies
- 无新增依赖
```

---

## F. 代码风格指南

### 中文化规范（强制）

```python
# 所有注释必须使用中文
class AmbiguityDetector:
    """歧义检测器，用于识别规范文档中的模糊表述。

    支持 9 大歧义分类：
    - 范围歧义：功能边界不清
    - 数据歧义：数据结构未定义
    - 接口歧义：API 规范缺失
    ...
    """

    def detect(self, content: str) -> AmbiguityReport:
        """检测内容中的歧义。

        参数：
            content: 要检测的文本内容

        返回：
            包含检测结果的 AmbiguityReport 对象
        """
        # 遍历所有歧义类型进行匹配
        for ambiguity_type in AmbiguityType:
            # 获取该类型的关键词列表
            keywords = AMBIGUITY_KEYWORDS.get(ambiguity_type, [])
            ...

# Rich 控制台输出使用中文
console.print("[green]✓[/green] 歧义检测完成，共发现 {count} 处问题")
console.print("[yellow]⚠[/yellow] 发现潜在歧义，建议使用 clarify 命令澄清")

# 错误提示使用中文
raise ValueError("配置文件格式错误：缺少必需的 'namespace' 字段")
raise FileNotFoundError(f"规范文件不存在：{spec_path}")
```

### 命名约定

```python
# 类名：PascalCase
class CommandTemplate:
class AmbiguityDetector:

# 函数名：snake_case
def get_execution_steps():
def detect_ambiguities():

# 常量：UPPER_SNAKE_CASE
AMBIGUITY_KEYWORDS = {}
DEFAULT_TIMEOUT = 300000

# 私有函数：前缀下划线
def _classify_item():
def _generate_questions():
```

### 类型注解

```python
# 所有函数必须有类型注解
def detect(self, content: str, file_path: str = "") -> AmbiguityReport:
    ...

# 复杂类型使用 typing
from typing import Optional
from collections.abc import Callable
```

### 文档字符串

```python
def detect(self, content: str, file_path: str = "") -> AmbiguityReport:
    """检测内容中的歧义。

    参数：
        content: 要检测的文本内容
        file_path: 文件路径（用于报告）

    返回：
        包含检测结果的 AmbiguityReport 对象
    """
```