# 01 - 背景与目标

## 业务目的

cc-spec v0.1.4 的核心目标是**补全四源融合设计**，将 Spec-Kit、OpenSpec、auto-dev、DOCUMENTATION-GUIDELINES
四个优秀项目的精华完整融入 cc-spec。

当前 v0.1.3 版本仅完成了**骨架实现**，缺失了四源融合的核心功能：
- 命令文件只有 ~20 行简单 CLI 调用（设计应为 ~250 行完整工作流指令）
- clarify 缺少 9 大歧义分类检测
- specify 缺少智能代码分析
- plan 缺少九段大纲和 Phase 0/1 流程
- checklist 打分未使用四维度加权
- Git 分布式锁未实现
- 技术硬要求未强制执行

## 上线标准

v0.1.4 发布前必须满足以下标准：

### 功能标准
- [ ] 命令文件生成器输出完整工作流指令（每个命令 150-300 行）
- [ ] clarify 命令具备 9 大歧义分类检测功能（含上下文判断）
- [ ] specify 命令具备智能代码分析和 Git 分支管理功能
- [ ] plan 命令遵循九段大纲和 Gate/Wave 并行规划
- [ ] checklist 打分使用四维度加权（功能 30%/质量 25%/测试 25%/文档 20%）
- [ ] Git 分布式锁完整实现（LockManager）
- [ ] 技术硬要求由主 Agent 统一执行
- [ ] **单一真相源**：合并 proposal.md + design.md 为统一文档
- [ ] **结构化任务**：tasks.md → tasks.yaml（体积降低 80%）
- [ ] **SubAgent 上下文优化**：从 ~5K 降到 ~500 tokens/agent
- [ ] **公共模板引用**：`$templates/` 机制避免检查清单重复

### 质量标准
- [ ] 所有测试通过：`uv run pytest`
- [ ] 类型检查通过：`uv run mypy src/cc_spec/`
- [ ] 代码规范通过：`uv run ruff check src/`
- [ ] 单文件不超过 500 行

### 文档标准
- [ ] README.md 更新版本号和功能说明
- [ ] 命令 `--help` 输出与功能一致

## 四源融合来源

| 来源 | 贡献内容 | 引用文件 |
|------|----------|----------|
| **Spec-Kit** | CLI 框架、模板结构、clarify 9 大歧义分类、checklist 打分 | `reference/spec-kit/` |
| **OpenSpec** | 多 AI 工具支持、Delta 变更追踪、智能代码分析、托管标记块 | `reference/openspec/` |
| **auto-dev** | SubAgent 并发执行、Git 分布式锁、Wave/Task 任务规划 | `reference/auto-dev/` |
| **DOCUMENTATION-GUIDELINES** | 九段大纲、技术硬要求、Gate/Wave 并行规划结构 | `reference/DOCUMENTATION-GUIDELINES.md` |

## 版本定位

```
v0.1.0 - 初始版本（骨架）
v0.1.1 - ID 系统（C-001/S-001/A-001）
v0.1.2 - Profile 配置支持
v0.1.3 - 四维度打分数据结构（但未完整使用）
v0.1.4 - 四源融合完整实现 ← 当前版本
```

## 技术约束

| 约束 | 说明 |
|------|------|
| Python 版本 | ≥3.10 |
| 单文件行数 | <500 行 |
| 依赖管理 | uv |
| 测试框架 | pytest |
| 类型检查 | mypy |
| 代码风格 | ruff |
| **注释语言** | **中文自然语言** |
| **提示文本** | **中文自然语言** |
| **命令命名空间** | **cc-spec** |
| **主 Agent 上下文** | **≤150K tokens** |
| **SubAgent 并发数** | **读取 config.yaml 的 subagent.max_concurrent** |

### 中文化要求

所有新增代码必须遵循以下中文化规范：

1. **代码注释**: 使用中文自然语言编写，清晰描述代码意图
2. **文档字符串**: 函数、类的 docstring 使用中文
3. **日志消息**: Rich 控制台输出使用中文
4. **错误提示**: 异常信息和用户提示使用中文
5. **模板内容**: 命令模板中的说明文字使用中文

### 命令命名规范

所有生成的 slash commands 必须统一使用 `cc-spec` 命名空间：

```
/cc-spec:specify    # 创建变更规范
/cc-spec:clarify    # 澄清歧义
/cc-spec:plan       # 生成执行计划
/cc-spec:apply      # 执行任务
/cc-spec:checklist  # 验收打分
/cc-spec:archive    # 归档变更
/cc-spec:list       # 列出资源
/cc-spec:goto       # 导航
/cc-spec:update     # 更新配置
```

### SubAgent 并发规划约束

plan 命令生成的 Wave/Task 规划必须遵循以下约束：

1. **读取配置文件**：从 `config.yaml` 的 `subagent.max_concurrent` 读取并发数量（默认 10）
2. **主 Agent 上下文限制**：主 Agent 上下文不能超过 150K tokens
3. **Wave 并发控制**：每个 Wave 内的并行任务数 ≤ `max_concurrent`
4. **任务粒度控制**：单个任务的预估上下文应控制在合理范围内

```yaml
# config.yaml 示例
subagent:
  max_concurrent: 10  # 最大并发 SubAgent 数量
  timeout: 300000     # 超时时间（毫秒）
```

### init 命令完成提示

init 命令完成后必须显示中文配置提示，引导用户完成配置：

```
✓ cc-spec 工作流初始化完成！

📁 已创建目录结构：
   .cc-spec/
   ├── config.yaml      # 项目配置文件
   ├── changes/         # 变更目录
   └── archive/         # 归档目录

⚙️  请配置 config.yaml：

   1. SubAgent 并发数量（默认 10）：
      subagent:
        max_concurrent: 10

   2. 启用的 AI 工具（推荐顺序）：
      agents:
        enabled:
          - claude    # 推荐首选
          - codex     # OpenAI Codex
          - gemini    # Google Gemini
          - cursor
          - copilot

   3. 评分通过阈值（默认 80）：
      scoring:
        pass_threshold: 80

📖 下一步：
   - 运行 cc-spec specify <变更名称> 创建新变更
   - 运行 cc-spec --help 查看所有命令
```

### AI 工具优先级

init 命令选择 AI 工具时的默认优先顺序：

| 优先级 | 工具 | 说明 |
|--------|------|------|
| 1 | claude | Anthropic Claude（推荐首选） |
| 2 | codex | OpenAI Codex |
| 3 | gemini | Google Gemini |
| 4 | cursor | Cursor IDE |
| 5 | copilot | GitHub Copilot |
| 6+ | 其他 | 其他支持的 AI 工具 |

## 新架构设计（v0.1.4 核心改进）

### 单一真相源

合并 `proposal.md` 和 `design.md` 为统一的 `proposal.md`：

```markdown
# proposal.md (新结构)

## 1. 背景与目标
(需求描述)

## 2. 用户故事
(验收场景)

## 3. 技术决策    ← 原 design.md 内容
- 选型/架构决策

## 4. 成功标准
(可量化指标)
```

### 结构化任务定义

将 `tasks.md`（Markdown）改为 `tasks.yaml`（YAML）：

```yaml
# tasks.yaml (~500 tokens vs 原 ~3000 tokens)
meta:
  change: add-oauth
  max_concurrent: 10

waves:
  - id: 0
    type: gate
    tasks:
      - id: T01
        name: 初始化项目结构
        refs: [src/]
        checklist: $templates/setup-checklist

  - id: 1
    type: wave
    tasks:
      - id: T02
        name: 实现登录功能
        deps: [T01]
        refs: [src/auth/login.py]
        checklist: $templates/feature-checklist
```

### SubAgent 上下文优化

```
主 Agent 预处理：
  - 读取 proposal.md → 生成摘要 (~200 tokens)
  - 解析 tasks.yaml → 提取当前任务
         ↓
SubAgent 只接收 (~500 tokens)：
  - 变更摘要 (~200)
  - 当前任务定义 (~100)
  - 相关文件路径 (~50)
  - 检查清单引用 (~100)

节省：(5K - 0.5K) × 10 SubAgents = ~45K tokens
```

### 目录结构（更新后）

```
.cc-spec/
├── config.yaml
├── templates/                    # 公共模板（新增）
│   ├── setup-checklist.md
│   ├── feature-checklist.md
│   └── test-checklist.md
├── changes/
│   └── <change-name>/
│       ├── proposal.md           # 单一真相源（合并后）
│       ├── tasks.yaml            # 结构化任务（新格式）
│       └── status.yaml
└── archive/
```
