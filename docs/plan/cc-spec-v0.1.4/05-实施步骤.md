# 05 - 实施步骤

本文档按 Gate/Wave 结构规划实施步骤，标注可并行/需串行。

---

## 总览

| Gate/Wave | 任务数 | 执行方式 | 预估行数 |
|-----------|--------|----------|----------|
| Gate-0 | 2 | 串行 | ~100 |
| Wave-1 | 3 | 并行 | ~800 |
| Wave-2 | 3 | 并行 | ~600 |
| Wave-3 | 2 | 并行 | ~400 |
| Wave-4 | 3 | 并行 | ~350 |
| Wave-5 | 4 | 并行 | ~500 |
| **总计** | **17** | - | **~2750** |

---

## Gate-0: 基础设施（串行）

### T01-TEMPLATE-BASE
**范围**: 创建命令模板基础设施

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/__init__.py`
- 新建 `src/cc_spec/core/command_templates/base.py`

**依赖**: 无

**必读文档**:
- `reference/test-project/speckitProject/.codex/prompts/speckit.specify.md`
- `src/cc_spec/core/command_generator.py:160-182`

**执行步骤**:
1. 创建 `command_templates/` 目录
2. 实现 `CommandTemplateContext` 数据类
3. 实现 `CommandTemplate` 抽象基类
4. 实现 `render()` 方法（markdown/toml）

**预估行数**: ~80

**Checklist**:
- [ ] `CommandTemplateContext` 包含 command_name, namespace, config_sources
- [ ] `CommandTemplate` 定义 get_outline(), get_execution_steps(), get_validation_checklist()
- [ ] `render()` 支持 markdown 和 toml 格式
- [ ] 基类测试通过

---

### T02-AMBIGUITY-BASE
**范围**: 创建歧义检测基础设施

**修改文件**:
- 新建 `src/cc_spec/core/ambiguity/__init__.py`
- 新建 `src/cc_spec/core/ambiguity/detector.py`

**依赖**: 无

**必读文档**:
- Spec-Kit clarify 9 大歧义分类设计
- `src/cc_spec/commands/clarify.py:182-278`

**执行步骤**:
1. 创建 `ambiguity/` 目录
2. 定义 `AmbiguityType` 枚举（9 种类型）
3. 实现 `Ambiguity` 和 `AmbiguityReport` 数据类
4. 定义 `AMBIGUITY_KEYWORDS` 关键词映射

**预估行数**: ~120

**Checklist**:
- [ ] `AmbiguityType` 包含 9 种分类
- [ ] `AMBIGUITY_KEYWORDS` 每种类型至少 5 个关键词
- [ ] 数据类测试通过

---

## Wave-1: 核心模块实现（并行）

### T03-SPECIFY-TEMPLATE
**范围**: 实现 specify 命令完整模板

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/specify_template.py`

**依赖**: T01-TEMPLATE-BASE

**必读文档**:
- `reference/test-project/speckitProject/.codex/prompts/speckit.specify.md` (全文)
- `src/cc_spec/commands/specify.py:68-109`

**执行步骤**:
1. 继承 `CommandTemplate`
2. 实现 7 步执行流程
3. 实现 Git 分支检查逻辑（模板内）
4. 实现验证检查清单
5. 实现 `[NEEDS CLARIFICATION]` 处理指引

**预估行数**: ~250

**Checklist**:
- [ ] 包含 7 个完整执行步骤
- [ ] Git 分支检查逻辑正确
- [ ] 验证检查清单包含所有必要项
- [ ] 输出格式符合 Spec-Kit 规范

---

### T04-CLARIFY-TEMPLATE
**范围**: 实现 clarify 命令完整模板

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/clarify_template.py`

**依赖**: T01-TEMPLATE-BASE

**必读文档**:
- Spec-Kit clarify 流程设计
- `src/cc_spec/commands/clarify.py` (全文)

**执行步骤**:
1. 继承 `CommandTemplate`
2. 实现歧义检测调用指引
3. 实现 9 大分类说明
4. 实现澄清问题生成格式

**预估行数**: ~200

**Checklist**:
- [ ] 包含歧义检测调用步骤
- [ ] 9 大分类均有说明和示例
- [ ] 问题生成格式符合表格规范

---

### T05-PLAN-TEMPLATE
**范围**: 实现 plan 命令完整模板

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/plan_template.py`

**依赖**: T01-TEMPLATE-BASE

**必读文档**:
- `reference/DOCUMENTATION-GUIDELINES.md` (全文)
- `src/cc_spec/commands/plan.py:31-211`

**执行步骤**:
1. 继承 `CommandTemplate`
2. 实现九段大纲生成指引
3. 实现 Gate/Wave 规划指引
4. 实现技术硬要求说明

**预估行数**: ~280

**Checklist**:
- [ ] 九段大纲完整
- [ ] Gate/Wave 规划格式正确
- [ ] 技术硬要求说明清晰

---

## Wave-2: 检测器和模板续（并行）

### T06-AMBIGUITY-DETECTOR
**范围**: 实现歧义检测器核心逻辑

**修改文件**:
- `src/cc_spec/core/ambiguity/detector.py` (续)

**依赖**: T02-AMBIGUITY-BASE

**必读文档**:
- `src/cc_spec/core/ambiguity/detector.py`

**执行步骤**:
1. 实现 `AmbiguityDetector.detect()` 方法
2. 实现关键词匹配逻辑
3. 实现上下文提取
4. 实现严重程度评估
5. 实现澄清问题生成

**预估行数**: ~200

**Checklist**:
- [ ] `detect()` 正确扫描内容
- [ ] 关键词匹配支持中英文
- [ ] 上下文包含前后各 2 行
- [ ] 澄清问题与歧义类型匹配

---

### T07-APPLY-TEMPLATE
**范围**: 实现 apply 命令完整模板

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/apply_template.py`

**依赖**: T01-TEMPLATE-BASE

**必读文档**:
- `src/cc_spec/commands/apply.py` (全文)
- `src/cc_spec/subagent/executor.py:272-381`

**执行步骤**:
1. 继承 `CommandTemplate`
2. 实现 SubAgent 执行指引
3. 实现锁机制说明
4. 实现技术检查步骤

**预估行数**: ~220

**Checklist**:
- [ ] SubAgent 执行流程清晰
- [ ] 锁机制使用说明完整
- [ ] 技术检查步骤正确

---

### T08-CHECKLIST-TEMPLATE
**范围**: 实现 checklist 命令完整模板

**修改文件**:
- 新建 `src/cc_spec/core/command_templates/checklist_template.py`

**依赖**: T01-TEMPLATE-BASE

**必读文档**:
- `src/cc_spec/core/scoring.py:443-513`
- `src/cc_spec/commands/checklist.py`

**执行步骤**:
1. 继承 `CommandTemplate`
2. 实现四维度打分说明
3. 实现权重计算指引
4. 实现改进建议生成

**预估行数**: ~180

**Checklist**:
- [ ] 四维度说明完整
- [ ] 权重计算公式正确
- [ ] 改进建议格式规范

---

## Wave-3: 技术检查和集成（并行）

### T09-TECH-CHECK
**范围**: 实现技术检查模块

**修改文件**:
- 新建 `src/cc_spec/core/tech_check/__init__.py`
- 新建 `src/cc_spec/core/tech_check/reader.py`
- 新建 `src/cc_spec/core/tech_check/detector.py`
- 新建 `src/cc_spec/core/tech_check/runner.py`

**依赖**: 无

**必读文档**:
- `src/cc_spec/core/config.py:203-208`
- `.claude/CLAUDE.md` (示例)

**执行步骤**:
1. 实现 `read_from_claude_md()` 函数
2. 实现 `detect_tech_stack()` 函数
3. 实现 `generate_default_commands()` 函数
4. 实现 `run_command()` 异步执行函数

**预估行数**: ~250

**Checklist**:
- [ ] 正确解析 CLAUDE.md 中的命令
- [ ] 技术栈检测支持 Python/Node/Go
- [ ] 默认命令生成正确
- [ ] 命令执行返回结果包含成功/失败状态

---

### T10-GENERATOR-REFACTOR
**范围**: 重构 command_generator.py 使用模板

**修改文件**:
- `src/cc_spec/core/command_generator.py` (重构)

**依赖**: T03, T04, T05, T07, T08

**必读文档**:
- `src/cc_spec/core/command_generator.py` (全文)
- 所有 `command_templates/*.py`

**执行步骤**:
1. 导入所有命令模板类
2. 创建 `COMMAND_TEMPLATES` 映射
3. 重写 `_get_md_content()` 使用模板
4. 重写 `_get_toml_content()` 使用模板
5. 保留简单命令的默认实现

**预估行数**: ~100 (净增)

**Checklist**:
- [ ] 所有主要命令使用模板
- [ ] 简单命令保持原有行为
- [ ] 生成内容长度 150-300 行
- [ ] 所有工具生成正确

---

## Wave-4: 命令集成和模板更新（并行）

### T11-CLARIFY-INTEGRATION
**范围**: 集成歧义检测到 clarify 命令

**修改文件**:
- `src/cc_spec/commands/clarify.py` (新增函数)

**依赖**: T06-AMBIGUITY-DETECTOR

**必读文档**:
- `src/cc_spec/commands/clarify.py` (全文)
- `src/cc_spec/core/ambiguity/detector.py`

**执行步骤**:
1. 导入 `AmbiguityDetector`
2. 实现 `detect_and_show_ambiguities()` 函数
3. 修改 `clarify()` 主函数调用检测
4. 添加 `--detect` 选项

**预估行数**: ~80

**Checklist**:
- [ ] `--detect` 选项可用
- [ ] 歧义报告格式正确
- [ ] 与现有功能兼容

---

### T12-APPLY-TECH-CHECK
**范围**: 集成技术检查到 apply 命令

**修改文件**:
- `src/cc_spec/commands/apply.py` (修改)

**依赖**: T09-TECH-CHECK

**必读文档**:
- `src/cc_spec/commands/apply.py:326-427`
- `src/cc_spec/core/tech_check/`

**执行步骤**:
1. 导入技术检查模块
2. 在 `_execute_with_progress()` 末尾添加检查
3. 实现 `run_tech_checks()` 函数
4. 将检查结果传递给后续流程

**预估行数**: ~60

**Checklist**:
- [ ] 主 Agent 执行检查（非 SubAgent）
- [ ] 从 CLAUDE.md 读取或自动检测
- [ ] 检查结果正确显示
- [ ] 不影响现有执行流程

---

## 关键路径

```
        │                        │           ├─→ T04-CLARIFY-TEMPLATE  │
        │                        │           └─→ T05-PLAN-TEMPLATE ────┼─→ T10
        │                        │                                     │
                                             ├─→ T07-APPLY-TEMPLATE ───┤
                                             └─→ T08-CHECKLIST-TEMPLATE┘


```

---

## 执行顺序总结

| 顺序 | 任务 | 执行方式 |
|------|------|----------|
| 1 | T01, T02 | **串行**（Gate-0 基础设施） |
| 2 | T03, T04, T05 | **并行**（Wave-1 核心模板） |
| 3 | T06, T07, T08 | **并行**（Wave-2 检测器和续模板） |
| 4 | T09, T10 | **并行**（Wave-3 技术检查和重构） |
| 5 | T11, T12, T13 | **并行**（Wave-4 命令集成和优化） |
| 6 | T14, T15, T16, T17 | **并行**（Wave-5 新架构实现） |

---

## 补充任务：T13-INIT-PROMPT

### T13-INIT-PROMPT
**范围**: init 命令完成后添加中文配置提示

**修改文件**:
- `src/cc_spec/commands/init.py` (修改)

**依赖**: 无

**执行步骤**:
1. 新增 `_show_init_complete_message()` 函数
2. 在 `init_command()` 末尾调用该函数
3. 显示目录结构、配置提示和下一步操作

**预估行数**: ~50

**Checklist**:
- [ ] 显示目录结构（.cc-spec/、config.yaml、changes/、archive/）
- [ ] 提示配置 subagent.max_concurrent
- [ ] 提示配置 agents.enabled（优先级：claude → codex → gemini）
- [ ] 提示配置 scoring.pass_threshold
- [ ] 显示下一步操作（specify、--help）
- [ ] 所有提示使用中文

---

## Wave-5: 新架构实现（并行）

### T14-SINGLE-SOURCE
**范围**: 实现单一真相源（合并 proposal.md + design.md）

**修改文件**:
- `src/cc_spec/commands/specify.py` (修改)
- `src/cc_spec/commands/plan.py` (修改)
- `src/cc_spec/templates/proposal-template.md` (新建/修改)

**依赖**: 无

**必读文档**:
- `src/cc_spec/commands/specify.py`
- `src/cc_spec/commands/plan.py`
- `04-设计方案.md:4.6`

**执行步骤**:
1. 更新 proposal 模板，添加"技术决策"章节
2. 修改 specify 命令生成新格式的 proposal.md
3. 移除 plan 命令的 design.md 生成逻辑
4. 更新相关测试

**预估行数**: ~120

**Checklist**:
- [ ] proposal.md 包含 4 个章节（背景与目标、用户故事、技术决策、成功标准）
- [ ] plan 命令不再生成 design.md
- [ ] 现有变更可正常迁移

---

### T15-TASKS-YAML
**范围**: 实现结构化任务定义（tasks.md → tasks.yaml）

**修改文件**:
- `src/cc_spec/commands/plan.py` (修改)
- `src/cc_spec/subagent/task_parser.py` (修改)

**依赖**: T14-SINGLE-SOURCE

**必读文档**:
- `src/cc_spec/commands/plan.py`
- `src/cc_spec/subagent/task_parser.py`
- `04-设计方案.md:4.7`

**执行步骤**:
1. 修改 plan 命令生成 tasks.yaml 而非 tasks.md
2. 实现 `parse_tasks_yaml()` 函数
3. 更新 task_parser.py 支持 YAML 格式
4. 支持 `$templates/` 引用语法

**预估行数**: ~150

**Checklist**:
- [ ] plan 命令生成 tasks.yaml
- [ ] tasks.yaml 体积 ≤ 原 tasks.md 的 20%
- [ ] 支持 `$templates/` 引用
- [ ] task_parser 正确解析新格式

---

### T16-CONTEXT-OPTIMIZE
**范围**: 实现 SubAgent 上下文优化

**修改文件**:
- `src/cc_spec/commands/apply.py` (修改)
- `src/cc_spec/subagent/executor.py` (修改)

**依赖**: T15-TASKS-YAML

**必读文档**:
- `src/cc_spec/commands/apply.py`
- `src/cc_spec/subagent/executor.py`
- `04-设计方案.md:4.8`

**执行步骤**:
1. 实现 `_generate_context_summary()` 函数
2. 实现 `_prepare_subagent_context()` 函数
3. 修改 executor 使用精简上下文
4. 验证 SubAgent 上下文 ≤ 500 tokens

**预估行数**: ~130

**Checklist**:
- [ ] 主 Agent 预处理生成变更摘要
- [ ] SubAgent 只接收精简上下文
- [ ] 上下文体积从 ~5K 降到 ~500 tokens
- [ ] 不影响 SubAgent 执行质量

---

### T17-TEMPLATE-REF
**范围**: 实现公共模板引用机制

**修改文件**:
- `src/cc_spec/core/templates.py` (修改)
- `src/cc_spec/commands/init.py` (修改)

**依赖**: 无

**必读文档**:
- `src/cc_spec/core/templates.py`
- `04-设计方案.md:4.9`

**执行步骤**:
1. 实现 `resolve_template_ref()` 函数
2. init 命令创建 `.cc-spec/templates/` 目录
3. 生成默认检查清单模板（setup/feature/test）
4. 更新文档说明

**预估行数**: ~100

**Checklist**:
- [ ] init 创建 templates/ 目录
- [ ] 默认模板包含 3 个检查清单
- [ ] `$templates/xxx` 引用正确解析
- [ ] 支持带或不带 .md 后缀