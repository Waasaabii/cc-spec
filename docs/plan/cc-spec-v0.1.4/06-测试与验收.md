# 06 - 测试与验收

本文档列出测试文件路径、命令、耗时预估和验收标准。

---

## 测试文件规划

### 新增测试文件

| 测试文件 | 对应模块 | 类型 |
|----------|----------|------|
| `tests/core/test_command_templates.py` | `command_templates/` | 单元 |
| `tests/core/test_ambiguity.py` | `ambiguity/` | 单元 |
| `tests/core/test_tech_check.py` | `tech_check/` | 单元 |
| `tests/integration/test_specify_workflow.py` | specify 完整流程 | 集成 |
| `tests/integration/test_clarify_detection.py` | clarify 歧义检测 | 集成 |
| `tests/integration/test_apply_tech_check.py` | apply 技术检查 | 集成 |

### 修改测试文件

| 测试文件 | 修改原因 |
|----------|----------|
| `tests/core/test_command_generator.py` | 适配新的模板系统 |
| `tests/commands/test_clarify.py` | 增加歧义检测测试 |
| `tests/commands/test_apply.py` | 增加技术检查测试 |

---

## 测试命令

### 单元测试

```bash
# 全部单元测试
uv run pytest tests/core/ tests/commands/ -v

# 按模块测试
uv run pytest tests/core/test_command_templates.py -v     # 命令模板
uv run pytest tests/core/test_ambiguity.py -v             # 歧义检测
uv run pytest tests/core/test_tech_check.py -v            # 技术检查
uv run pytest tests/core/test_scoring.py -v               # 打分机制
```

### 集成测试

```bash
# 全部集成测试
uv run pytest tests/integration/ -v

# 按流程测试
uv run pytest tests/integration/test_specify_workflow.py -v
uv run pytest tests/integration/test_clarify_detection.py -v
uv run pytest tests/integration/test_apply_tech_check.py -v
```

### 覆盖率测试

```bash
# 带覆盖率的全部测试
uv run pytest --cov=cc_spec --cov-report=term-missing

# 生成 HTML 报告
uv run pytest --cov=cc_spec --cov-report=html
```

---

## 测试用例详情

### test_command_templates.py

```python
# tests/core/test_command_templates.py

class TestCommandTemplateBase:
    """测试命令模板基类"""

    def test_render_markdown(self):
        """测试 Markdown 渲染"""
        template = SpecifyTemplate()
        content = template.render("markdown")
        assert "## User Input" in content
        assert "## Execution Steps" in content
        assert len(content) > 150  # 至少 150 行字符

    def test_render_toml(self):
        """测试 TOML 渲染"""
        template = SpecifyTemplate()
        content = template.render("toml")
        assert "description =" in content

    def test_all_templates_have_required_sections(self):
        """测试所有模板都有必要章节"""
        templates = [
            SpecifyTemplate,
            ClarifyTemplate,
            PlanTemplate,
            ApplyTemplate,
            ChecklistTemplate,
        ]
        for template_cls in templates:
            template = template_cls()
            content = template.render("markdown")
            assert "## Outline" in content or "outline" in content.lower()
            assert "## Execution Steps" in content or "steps" in content.lower()
```

### test_ambiguity.py

```python
# tests/core/test_ambiguity.py

class TestAmbiguityDetector:
    """测试歧义检测器"""

    def test_detect_scope_ambiguity(self):
        """测试范围歧义检测"""
        content = "这个功能可能需要支持多租户"
        detector = AmbiguityDetector()
        report = detector.detect(content)
        assert report.total_count > 0
        assert any(a.type == AmbiguityType.SCOPE for a in report.ambiguities)

    def test_detect_multiple_types(self):
        """测试多类型歧义检测"""
        content = """
        接口待定，性能要求视情况而定。
        数据结构TBD，安全权限后续确认。
        """
        detector = AmbiguityDetector()
        report = detector.detect(content)
        assert report.total_count >= 2

    def test_no_ambiguity(self):
        """测试无歧义内容"""
        content = "用户必须能够在 2 秒内完成登录操作。"
        detector = AmbiguityDetector()
        report = detector.detect(content)
        assert report.total_count == 0

    def test_context_extraction(self):
        """测试上下文提取"""
        content = "第一行\n第二行\n可能需要\n第四行\n第五行"
        detector = AmbiguityDetector()
        report = detector.detect(content)
        assert len(report.ambiguities) > 0
        assert "第二行" in report.ambiguities[0].context
```

### test_tech_check.py

```python
# tests/core/test_tech_check.py

class TestTechStackDetector:
    """测试技术栈检测"""

    def test_detect_python_project(self, tmp_path):
        """测试 Python 项目检测"""
        (tmp_path / "pyproject.toml").write_text("[project]\nname = 'test'")
        result = detect_tech_stack(tmp_path)
        assert result["language"] == "python"
        assert result["lint_tool"] == "ruff"

    def test_detect_nodejs_project(self, tmp_path):
        """测试 Node.js 项目检测"""
        (tmp_path / "package.json").write_text('{"name": "test"}')
        result = detect_tech_stack(tmp_path)
        assert result["language"] == "nodejs"

    def test_detect_unknown_project(self, tmp_path):
        """测试未知项目"""
        result = detect_tech_stack(tmp_path)
        assert result["language"] is None

class TestClaudeMdReader:
    """测试 CLAUDE.md 读取"""

    def test_read_commands(self, tmp_path):
        """测试读取检查命令"""
        claude_dir = tmp_path / ".claude"
        claude_dir.mkdir()
        (claude_dir / "CLAUDE.md").write_text("""
# CLAUDE.md

## 开发命令

```bash
uv run ruff check src/
uv run pytest
```
""")
        config = read_from_claude_md(tmp_path)
        assert config is not None
        assert len(config.lint_commands) > 0
        assert "ruff" in config.lint_commands[0]
```

---

## 耗时预估

| 测试类型 | 测试数量 | 预估耗时 |
|----------|----------|----------|
| 单元测试 | ~50 | ~30s |
| 集成测试 | ~15 | ~60s |
| **总计** | ~65 | ~90s |

---

## 验收标准

### 功能验收

| 验收项 | 验收方式 | 通过标准 |
|--------|----------|----------|
| 命令文件长度 | 检查生成文件 | 每个命令 150-300 行 |
| 歧义检测准确率 | 测试用例 | ≥80% 准确率 |
| 技术栈检测 | 测试用例 | Python/Node/Go 正确 |
| 四维度打分 | 测试用例 | 权重计算正确 |

### 质量验收

```bash
# 必须全部通过
uv run ruff check src/                    # 0 errors
uv run mypy src/cc_spec/                  # 0 errors
uv run pytest                             # 全部通过
uv run pytest --cov=cc_spec               # 覆盖率 ≥70%
```

### 文档验收

| 验收项 | 验收方式 |
|--------|----------|
| README.md | 版本号更新为 0.1.4 |
| `--help` 输出 | 与功能一致 |
| 命令模板 | 包含完整执行步骤 |

---

## 回归测试

v0.1.4 发布前需通过以下回归测试：

```bash
# 现有功能回归
uv run pytest tests/commands/test_init.py -v
uv run pytest tests/commands/test_specify.py -v
uv run pytest tests/commands/test_plan.py -v
uv run pytest tests/commands/test_apply.py -v
uv run pytest tests/commands/test_checklist.py -v
uv run pytest tests/commands/test_archive.py -v

# 核心模块回归
uv run pytest tests/core/test_config.py -v
uv run pytest tests/core/test_state.py -v
uv run pytest tests/core/test_scoring.py -v
uv run pytest tests/core/test_id_manager.py -v
```