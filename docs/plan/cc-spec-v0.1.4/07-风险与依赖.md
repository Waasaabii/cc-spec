# 07 - 风险与依赖

本文档列出外部服务、数据、权限、迁移冲突等风险与依赖。

---

## 风险评估

### R1: 命令模板过长导致上下文溢出

**描述**: 命令模板从 ~20 行扩展到 ~250 行，可能导致 AI 工具上下文压力增加。

**严重程度**: 中

**影响范围**: 所有 AI 工具命令执行

**缓解措施**:
- 模板采用分层结构，关键信息前置
- 提供"简洁模式"选项（`--minimal`）
- 测试各 AI 工具的实际表现

**应对方案**: 如发现问题，回退到简化版本并分阶段展开

---

### R2: 歧义检测误报率

**描述**: 关键词匹配可能产生误报（如"可能"在正常语境中使用）。

**严重程度**: 低

**影响范围**: clarify 命令用户体验

**缓解措施**:
- 结合上下文判断
- 提供忽略标记（`<!-- cc-spec:ignore -->`）
- 允许用户调整关键词列表

**应对方案**: 收集用户反馈，迭代优化关键词列表

---

### R3: CLAUDE.md 格式不统一

**描述**: 不同项目的 CLAUDE.md 格式可能不一致，导致命令解析失败。

**严重程度**: 中

**影响范围**: 技术检查命令读取

**缓解措施**:
- 支持多种章节标题格式
- 提供回退到智能检测
- 文档说明推荐格式

**应对方案**: 解析失败时自动使用技术栈检测生成默认命令

---

### R4: 技术栈检测不准确

**描述**: 混合技术栈项目（如 Python + Node）可能检测不准确。

**严重程度**: 低

**影响范围**: 技术检查命令生成

**缓解措施**:
- 支持多技术栈检测
- 允许在 config.yaml 手动配置
- 提供 `--tech-stack` 命令行选项

**应对方案**: 检测失败时提示用户手动配置

---

### R5: 模板系统向后兼容

**描述**: 新模板系统需要与现有 init 生成的命令文件兼容。

**严重程度**: 高

**影响范围**: 已有项目升级

**缓解措施**:
- 保留 `MANAGED_START/MANAGED_END` 标记
- `update` 命令仅更新受管理区块
- 提供迁移指南文档

**应对方案**: 提供 `cc-spec update --force` 强制重新生成所有命令

---

## 依赖列表

### 内部依赖

| 依赖项 | 版本要求 | 用途 |
|--------|----------|------|
| `cc_spec.core.config` | v1.2+ | 配置读取 |
| `cc_spec.core.state` | v1.0+ | 状态管理 |
| `cc_spec.core.scoring` | v1.3+ | 四维度打分 |
| `cc_spec.subagent.executor` | v1.3+ | 任务执行 |

### 外部依赖

| 依赖项 | 版本要求 | 用途 |
|--------|----------|------|
| `typer` | ≥0.9.0 | CLI 框架 |
| `rich` | ≥13.0.0 | 终端 UI |
| `pyyaml` | ≥6.0 | YAML 解析 |

### 可选依赖

| 依赖项 | 用途 |
|--------|------|
| `.claude/CLAUDE.md` | 技术检查命令读取 |
| `AGENTS.md` | 项目规范读取 |
| `pyproject.toml` | Python 项目检测 |
| `package.json` | Node.js 项目检测 |

---

## 迁移冲突

### 现有命令文件

**问题**: 已有项目可能已自定义命令文件内容。

**解决方案**:
1. `MANAGED_START/MANAGED_END` 区块内容可被安全更新
2. 区块外的用户自定义内容会被保留
3. 提供 `cc-spec update --preview` 预览变更

### 配置文件版本

**问题**: config.yaml 可能需要新字段。

**解决方案**:
1. 新增字段使用默认值
2. `load_config()` 自动迁移旧版本
3. 无需用户手动修改

---

## 回滚方案

如 v0.1.4 发布后发现严重问题：

1. **代码回滚**: `git revert` 到 v0.1.3 tag
2. **PyPI 回滚**: 发布 v0.1.4.post1 hotfix 或撤回版本
3. **用户通知**: 更新 README 和 GitHub Issues

---

## 风险矩阵

| 风险 | 可能性 | 影响 | 优先级 |
|------|--------|------|--------|
| R1 上下文溢出 | 中 | 中 | P2 |
| R2 误报率 | 高 | 低 | P3 |
| R3 格式不统一 | 中 | 中 | P2 |
| R4 检测不准确 | 中 | 低 | P3 |
| R5 向后兼容 | 低 | 高 | P1 |