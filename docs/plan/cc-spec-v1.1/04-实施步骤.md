# 04 - 实施步骤

## 实施阶段概览

```
Gate 0: ID 管理基础
   ↓
Gate 1: 新增命令
   ↓
Gate 2: 现有命令改造
   ↓
Gate 3: Subagent 配置扩展
   ↓
Gate 4: 斜杠命令生成
   ↓
Gate 5: 测试与文档
   ↓
发布 v1.1
```

---

## Gate 0: ID 管理基础

### 目标

建立 ID 管理机制，为后续命令提供基础支持。

### 步骤

#### 0.1 创建 ID 管理模块

```python
# core/id_manager.py

from pathlib import Path
from dataclasses import dataclass
from enum import Enum
import yaml

class IDType(Enum):
    CHANGE = "C"
    TASK = "T"
    SPEC = "S"
    ARCHIVE = "A"

@dataclass
class ParsedID:
    type: IDType
    change_id: str | None
    task_id: str | None
    full_id: str

class IDManager:
    def __init__(self, cc_spec_root: Path):
        self.cc_spec_root = cc_spec_root
        self.id_map_path = cc_spec_root / "id-map.yaml"
        self._id_map = self._load_id_map()

    def _load_id_map(self) -> dict:
        """加载或初始化 ID 映射"""
        ...

    def generate_change_id(self) -> str:
        """生成新变更 ID"""
        ...

    def parse_id(self, id_str: str) -> ParsedID:
        """解析 ID 字符串"""
        ...

    def resolve_path(self, id_str: str) -> Path | None:
        """解析 ID 对应的路径"""
        ...

    def register_change(self, name: str, path: Path) -> str:
        """注册新变更"""
        ...
```

#### 0.2 创建 ID 映射文件

```yaml
# .cc-spec/id-map.yaml
version: "1.0"
changes: {}
specs: {}
archive: {}
next_change_id: 1
```

#### 0.3 集成到 specify 命令

修改 `commands/specify.py`，在创建变更时注册 ID。

### 验收标准

- [ ] `IDManager` 可正确生成、解析 ID
- [ ] ID 映射文件可正确读写
- [ ] `specify` 命令创建变更时自动注册 ID
- [ ] 单元测试覆盖 ID 管理模块

---

## Gate 1: 新增命令

### 目标

实现 `list`、`goto`、`update` 三个新命令。

### 步骤

#### 1.1 实现 list 命令

```python
# commands/list.py

@app.command("list")
def list_command(
    type: str = typer.Argument("changes"),
    change: str = typer.Option(None, "--change", "-c"),
    status: str = typer.Option(None, "--status", "-s"),
    format: str = typer.Option("table", "--format", "-f"),
):
    """列出变更、任务、规格或归档记录"""
    cc_spec_root = find_cc_spec_root()
    id_manager = IDManager(cc_spec_root)

    if type == "changes":
        list_changes(cc_spec_root, id_manager, status, format)
    elif type == "tasks":
        list_tasks(cc_spec_root, id_manager, change, status, format)
    elif type == "specs":
        list_specs(cc_spec_root, id_manager, format)
    elif type == "archive":
        list_archive(cc_spec_root, id_manager, format)
```

#### 1.2 实现 goto 命令

```python
# commands/goto.py

@app.command("goto")
def goto_command(
    id: str = typer.Argument(...),
    force: bool = typer.Option(False, "--force", "-f"),
):
    """智能跳转到指定变更或任务"""
    cc_spec_root = find_cc_spec_root()
    id_manager = IDManager(cc_spec_root)

    parsed = id_manager.parse_id(id)

    if parsed.type == IDType.CHANGE:
        goto_change(cc_spec_root, parsed.change_id, force)
    elif parsed.type == IDType.TASK:
        goto_task(cc_spec_root, parsed.change_id, parsed.task_id, force)
    else:
        console.print(f"[red]不支持的 ID 类型: {id}[/red]")
```

#### 1.3 实现 update 命令

```python
# commands/update.py

@app.command("update")
def update_command(
    target: str = typer.Argument(None),
    add_agent: list[str] = typer.Option(None, "--add-agent", "-a"),
    templates: bool = typer.Option(False, "--templates", "-t"),
    force: bool = typer.Option(False, "--force", "-f"),
):
    """更新配置、斜杠命令或模板"""
    cc_spec_root = find_cc_spec_root()
    config = load_config(cc_spec_root / "config.yaml")

    if add_agent:
        add_agents(cc_spec_root, config, add_agent)

    if templates:
        update_templates(cc_spec_root)

    if target == "commands" or target is None:
        update_slash_commands(cc_spec_root, config)

    if target == "subagent" or target is None:
        update_subagent_config(cc_spec_root, config)
```

#### 1.4 注册新命令

```python
# __init__.py

from cc_spec.commands import list as list_cmd
from cc_spec.commands import goto as goto_cmd
from cc_spec.commands import update as update_cmd

app.command(name="list", help="List changes, tasks, specs or archives")(
    list_cmd.list_command
)
app.command(name="goto", help="Navigate to a specific change or task")(
    goto_cmd.goto_command
)
app.command(name="update", help="Update configuration, commands or templates")(
    update_cmd.update_command
)
```

### 验收标准

- [ ] `cc-spec list` 可列出变更、任务、规格、归档
- [ ] `cc-spec goto C-001` 可跳转到变更
- [ ] `cc-spec goto C-001:02-MODEL` 可跳转到任务
- [ ] `cc-spec update` 可更新配置
- [ ] `cc-spec update --add-agent gemini` 可添加 AI 工具
- [ ] 所有命令 `--help` 显示正确

---

## Gate 2: 现有命令改造

### 目标

为所有现有命令添加 ID 参数支持。

### 步骤

#### 2.1 修改 specify 命令

```python
# commands/specify.py

def specify(
    name_or_id: str = typer.Argument(..., help="变更名称或 ID"),
    template: str = typer.Option("default"),
):
    """创建或编辑变更规格"""
    id_manager = IDManager(find_cc_spec_root())

    if name_or_id.startswith("C-"):
        # ID 模式：编辑现有变更
        path = id_manager.resolve_path(name_or_id)
        edit_existing_change(path)
    else:
        # 名称模式：创建新变更
        create_new_change(name_or_id, template, id_manager)
```

#### 2.2 修改 clarify 命令

```python
# commands/clarify.py

def clarify(
    id: str = typer.Argument(None, help="变更 ID 或任务 ID"),
    change: str = typer.Option(None, help="变更名称（已废弃，使用 ID）"),
):
    """澄清需求或返工任务"""
    # 支持 C-001、C-001:02-MODEL、02-MODEL 格式
    ...
```

#### 2.3 修改其他命令

同样的模式应用于 `plan`、`apply`、`checklist`、`archive`。

### 验收标准

- [ ] `cc-spec specify C-001` 可编辑现有变更
- [ ] `cc-spec clarify C-001` 可查看变更任务
- [ ] `cc-spec clarify C-001:02-MODEL` 可返工指定任务
- [ ] `cc-spec plan C-001` 可重新规划
- [ ] `cc-spec apply C-001` 可继续执行
- [ ] 向后兼容：旧的名称参数仍然可用

---

## Gate 3: Subagent 配置扩展

### 目标

扩展 Subagent 配置支持 common/profiles。

### 步骤

#### 3.1 扩展配置数据结构

```python
# core/config.py

@dataclass
class SubAgentProfile:
    model: str = "sonnet"
    timeout: int = 300000
    permissionMode: str = "default"
    tools: str | None = None
    description: str = ""

@dataclass
class SubAgentConfig:
    max_concurrent: int = 10
    common: SubAgentProfile = field(default_factory=SubAgentProfile)
    profiles: dict[str, SubAgentProfile] = field(default_factory=dict)

    def get_profile(self, name: str) -> SubAgentProfile:
        """获取配置模板（继承 common）"""
        ...
```

#### 3.2 修改 task_parser 支持 Profile

```python
# subagent/task_parser.py

@dataclass
class Task:
    id: str
    wave: int
    status: str
    profile: str = "default"  # 新增
    # ...
```

#### 3.3 修改 executor 使用 Profile

```python
# subagent/executor.py

def build_prompt(self, task: Task, context: Context) -> str:
    profile = context.config.subagent.get_profile(task.profile)
    # 使用 profile 中的 model、timeout 等配置
    ...
```

### 验收标准

- [ ] config.yaml 支持 subagent.common 和 subagent.profiles
- [ ] tasks.md 可指定 Profile 字段
- [ ] executor 正确使用 Profile 配置
- [ ] 默认使用 common 配置

---

## Gate 4: 斜杠命令生成

### 目标

实现多 AI 工具的斜杠命令生成。

### 步骤

#### 4.1 创建命令生成器

```python
# core/command_generator.py

class CommandGenerator(ABC):
    file_format: str
    folder: str

    @abstractmethod
    def generate_command(self, cmd_name: str, project_path: Path) -> Path:
        ...

class ClaudeCommandGenerator(CommandGenerator):
    file_format = "markdown"
    folder = ".claude/commands/speckit/"

class GeminiCommandGenerator(CommandGenerator):
    file_format = "toml"
    folder = ".gemini/commands/speckit/"

# 注册表
COMMAND_GENERATORS = {
    "claude": ClaudeCommandGenerator,
    "cursor": CursorCommandGenerator,
    # ... 17+ 工具
}
```

#### 4.2 创建命令模板

```
src/cc_spec/templates/commands/
├── list.md.j2
├── goto.md.j2
├── update.md.j2
├── specify.md.j2
├── clarify.md.j2
├── plan.md.j2
├── apply.md.j2
├── checklist.md.j2
├── archive.md.j2
└── quick-delta.md.j2
```

#### 4.3 集成到 init 和 update 命令

- `init` 首次生成所有命令文件
- `update` 更新现有命令文件（保留用户自定义内容）

### 验收标准

- [ ] `cc-spec init --ai claude` 生成 `.claude/commands/speckit/*.md`
- [ ] `cc-spec init --ai gemini` 生成 `.gemini/commands/speckit/*.toml`
- [ ] `cc-spec update commands` 更新命令文件
- [ ] 托管标记块正确保留用户自定义内容

---

## Gate 5: 测试与文档

### 目标

完善测试覆盖和更新文档。

### 步骤

#### 5.1 单元测试

```
tests/
├── test_id_manager.py
├── test_command_generator.py
├── test_list_command.py
├── test_goto_command.py
├── test_update_command.py
└── test_subagent_profile.py
```

#### 5.2 集成测试

```
tests/integration/
├── test_id_workflow.py       # ID 创建 → 列表 → 跳转
├── test_update_workflow.py   # 更新配置 → 验证生效
└── test_profile_workflow.py  # Profile 配置 → apply 使用
```

#### 5.3 更新文档

- 更新 `README.md` 命令说明
- 更新 `docs/plan/cc-spec-v1.1/README.md` 状态为完成
- 创建升级指南 `docs/upgrade-v1.1.md`

### 验收标准

- [ ] 单元测试覆盖率 > 80%
- [ ] 集成测试通过
- [ ] 文档更新完成
- [ ] `uv run cc-spec --help` 显示 11 个命令

---

## 里程碑检查点

| Gate | 产出 | 关键验收 |
|------|------|----------|
| Gate 0 | ID 管理模块 | ID 生成/解析正常 |
| Gate 1 | 3 个新命令 | list/goto/update 可用 |
| Gate 2 | 命令改造 | 所有命令支持 ID |
| Gate 3 | 配置扩展 | Profile 配置生效 |
| Gate 4 | 命令生成 | 17+ 工具模板生成 |
| Gate 5 | 测试文档 | 可发布 v1.1 |

---

## 风险与应对

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| ID 映射文件损坏 | 高 | 支持从目录重建 ID 映射 |
| 向后兼容问题 | 中 | 保留旧参数，标记 deprecated |
| 模板格式变化 | 中 | 版本化模板，支持迁移 |
| AI 工具配置差异 | 中 | 抽象生成器，统一接口 |

---

*基于 v1.1 设计方案编写*
