# 02 - 现状分析

## v1.0 现有实现

### 命令实现状态

| 命令 | 文件 | 状态 | 说明 |
|------|------|------|------|
| `init` | `commands/init.py` | ✅ 完成 | 初始化项目，下载模板 |
| `specify` | `commands/specify.py` | ✅ 完成 | 创建变更规格 |
| `clarify` | `commands/clarify.py` | ✅ 完成 | 澄清需求/返工任务 |
| `plan` | `commands/plan.py` | ✅ 完成 | 生成执行计划 |
| `apply` | `commands/apply.py` | ✅ 完成 | SubAgent 并发执行 |
| `checklist` | `commands/checklist.py` | ✅ 完成 | 验收打分 |
| `archive` | `commands/archive.py` | ✅ 完成 | 归档变更 |
| `quick-delta` | `commands/quick_delta.py` | ✅ 完成 | 超简单模式 |

### 模块结构

```
src/cc_spec/
├── __init__.py              # CLI 入口，注册 8 个命令
├── __main__.py              # python -m cc_spec 支持
├── commands/                # 命令实现
│   ├── init.py
│   ├── specify.py
│   ├── clarify.py
│   ├── plan.py
│   ├── apply.py
│   ├── checklist.py
│   ├── archive.py
│   └── quick_delta.py
├── core/                    # 核心模块
│   ├── config.py            # 配置管理
│   ├── state.py             # 状态管理
│   └── templates.py         # 模板处理
├── subagent/                # SubAgent 模块
│   ├── executor.py          # 并发执行器
│   ├── task_parser.py       # tasks.md 解析
│   └── result_collector.py  # 结果收集
├── ui/                      # 终端 UI
│   ├── display.py           # 显示组件
│   ├── progress.py          # 进度条
│   └── prompts.py           # 交互提示
└── utils/                   # 工具函数
    ├── files.py             # 文件操作
    └── download.py          # 模板下载
```

### 配置结构 (config.yaml)

```yaml
# 当前 v1.0 配置格式
version: "1.0"
agent: "claude"
project_name: "my-project"

tech_requirements_sources:
  - ".claude/CLAUDE.md"
  - "AGENTS.md"
  - "pyproject.toml"
  - "package.json"

subagent:
  max_concurrent: 10
  timeout: 300000

checklist:
  pass_threshold: 80
  auto_retry: false
```

### 状态管理 (state.py)

```python
class Stage(Enum):
    SPECIFY = "specify"
    CLARIFY = "clarify"
    PLAN = "plan"
    APPLY = "apply"
    CHECKLIST = "checklist"
    ARCHIVE = "archive"

class TaskStatus(Enum):
    PENDING = "pending"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    FAILED = "failed"
    TIMEOUT = "timeout"
```

---

## 缺口分析

### 1. 缺少统一列表能力

**现状**：
- `clarify` 命令可显示任务列表，但仅限当前变更
- 无法列出所有变更、规格、归档记录
- 无法跨变更查看状态

**需要**：
- 新增 `cc-spec list` 命令
- 支持 `list changes` / `list tasks` / `list specs` / `list archive`
- 支持过滤和排序

### 2. 缺少 ID 管理机制

**现状**：
- 命令使用变更名称（如 `add-oauth`）作为标识
- 无统一的 ID 格式
- 回溯需要记住完整名称

**需要**：
- 新增 `core/id_manager.py` 模块
- 定义 ID 格式：`C-{序号}` (变更) / `C-xxx:task-id` (任务)
- 所有命令支持 ID 参数

### 3. 缺少配置更新命令

**现状**：
- `init` 命令一次性生成配置
- 新增 AI 工具需要重新 init
- 斜杠命令模板无法单独更新

**需要**：
- 新增 `cc-spec update` 命令
- 支持更新斜杠命令模板
- 支持新增 AI 工具
- 支持更新 Subagent 配置

### 4. Subagent 配置不支持继承

**现状**：
```yaml
# config.yaml 中的 subagent 配置
subagent:
  max_concurrent: 10
  timeout: 300000
```

- 只有全局配置
- 无法按任务类型设置不同配置
- 无法使用 `sonnet[1m]` 扩展上下文

**需要**：
```yaml
# v1.1 扩展配置
subagent:
  common:
    model: "sonnet[1m]"
    timeout: 300000
    permissionMode: "acceptEdits"
  profiles:
    quick:
      model: "haiku"
      timeout: 60000
    heavy:
      model: "opus"
      timeout: 600000
```

### 5. 斜杠命令模板不完整

**现状**：
- `init` 生成基础斜杠命令
- 缺少 `list`、`goto`、`update` 命令模板
- 命令模板更新需要重新 init

**需要**：
- 新增 `/speckit.list` 模板
- 新增 `/speckit.goto` 模板
- 新增 `/speckit.update` 模板
- 支持模板热更新

---

## 需要修改的模块

### 核心模块新增

| 模块 | 说明 |
|------|------|
| `core/id_manager.py` | ID 生成、解析、映射 |
| `core/command_generator.py` | 斜杠命令生成器（多 AI 工具） |

### 命令新增

| 命令 | 文件 | 说明 |
|------|------|------|
| `list` | `commands/list.py` | 列出变更/任务/规格/归档 |
| `goto` | `commands/goto.py` | 智能跳转 |
| `update` | `commands/update.py` | 配置更新 |

### 现有模块修改

| 模块 | 修改内容 |
|------|----------|
| `core/config.py` | 扩展 SubAgentConfig 支持 common/profiles |
| `commands/specify.py` | 添加 ID 参数支持 |
| `commands/clarify.py` | 添加 ID 参数支持 |
| `commands/plan.py` | 添加 ID 参数支持 |
| `commands/apply.py` | 添加 ID 参数支持，使用 profiles 配置 |
| `commands/checklist.py` | 添加 ID 参数支持 |
| `commands/archive.py` | 添加 ID 参数支持 |
| `__init__.py` | 注册新命令 |

---

## AI 工具支持现状

v1.0 的 `detect_agent()` 支持以下工具检测：

| 工具 | 目录标记 | 状态 |
|------|----------|------|
| Claude Code | `.claude/` | ✅ |
| Cursor | `.cursor/` | ✅ |
| Gemini CLI | `.gemini/` | ✅ |
| GitHub Copilot | `.github/copilot/` | ✅ |
| Amazon Q | `.amazonq/` | ✅ |
| Windsurf | `.windsurf/` | ✅ |
| Qwen | `.qwen/` | ✅ |

**v1.1 需要同步 Spec-Kit 的完整 AGENT_CONFIG（17+ 工具）**。

---

*基于 src/cc_spec/ 源码分析*
