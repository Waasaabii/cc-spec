# cc-spec v1.2 - è®¾è®¡æ–¹æ¡ˆ

## 1. æ¶æ„æ¦‚è§ˆ

v1.2 åœ¨ v1.1 åŸºç¡€ä¸Šè¿›è¡Œå¢é‡æ”¹è¿›ï¼Œä¸æ”¹å˜æ ¸å¿ƒæ¶æ„ã€‚

```
src/cc_spec/
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ config.py          # [ä¿®æ”¹] æ·»åŠ  agents å­—æ®µ
â”‚   â”œâ”€â”€ id_manager.py      # [ä¸å˜]
â”‚   â”œâ”€â”€ command_generator.py # [ä¿®æ”¹] è¡¥å…¨ç”Ÿæˆå™¨
â”‚   â””â”€â”€ ...
â”œâ”€â”€ subagent/
â”‚   â””â”€â”€ task_parser.py     # [ä¿®æ”¹] æ·»åŠ  Profile è§£æ
â”œâ”€â”€ commands/
â”‚   â”œâ”€â”€ update.py          # [ä¿®æ”¹] çœŸå®æ¨¡æ¿æ›´æ–°
â”‚   â”œâ”€â”€ goto.py            # [å¯é€‰] è‡ªåŠ¨æ‰§è¡Œ
â”‚   â””â”€â”€ ...
â””â”€â”€ utils/
    â””â”€â”€ download.py        # [å¯é€‰] æ¨¡æ¿ä¸‹è½½
```

## 2. æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

### 2.1 task_parser Profile è§£æ

#### 2.1.1 ç›®æ ‡

æ”¯æŒåœ¨ tasks.md ä¸­ä¸ºæ¯ä¸ªä»»åŠ¡æŒ‡å®šæ‰§è¡Œé…ç½®ï¼š

```markdown
### Task: 01-SETUP
**Profile**: quick
**é¢„ä¼°ä¸Šä¸‹æ–‡**: ~30k tokens
```

#### 2.1.2 æ•°æ®ç»“æ„å˜æ›´

```python
# subagent/task_parser.py

@dataclass
class TaskInfo:
    task_id: str
    name: str
    wave: int
    dependencies: list[str]
    estimate: str
    status: TaskStatus
    checklist: list[str]
    # v1.2 æ–°å¢
    profile: str | None = None  # å¯é€‰ï¼Œä¸æŒ‡å®šåˆ™ä½¿ç”¨ common
```

#### 2.1.3 è§£æé€»è¾‘

```python
def _parse_task_section(self, content: str, task_id: str) -> TaskInfo:
    """è§£æå•ä¸ªä»»åŠ¡æ®µè½"""
    # ç°æœ‰å­—æ®µè§£æ...

    # v1.2: è§£æ Profile å­—æ®µ
    profile_match = re.search(
        r"\*\*Profile\*\*:\s*(\w+)",
        content
    )
    profile = profile_match.group(1) if profile_match else None

    return TaskInfo(
        task_id=task_id,
        # ... ç°æœ‰å­—æ®µ
        profile=profile,
    )
```

#### 2.1.4 apply å‘½ä»¤é›†æˆ

```python
# commands/apply.py

async def _execute_task(self, task: TaskInfo) -> ExecutionResult:
    """æ‰§è¡Œå•ä¸ªä»»åŠ¡"""
    # è·å–ä»»åŠ¡é…ç½®
    profile_name = task.profile or "common"
    profile = self.config.subagent.get_profile(profile_name)

    # ä½¿ç”¨é…ç½®æ‰§è¡Œ
    return await self.executor.execute(
        task=task,
        model=profile.model,
        timeout=profile.timeout,
        permission_mode=profile.permissionMode,
        tools=profile.tools,
    )
```

### 2.2 Config agents å­—æ®µ

#### 2.2.1 ç›®æ ‡

æ”¯æŒé¡¹ç›®é…ç½®å¤šä¸ª AI å·¥å…·ï¼Œä¾¿äºå›¢é˜Ÿåä½œï¼š

```yaml
# .cc-spec/config.yaml
version: "1.2"

agents:
  enabled:
    - claude
    - cursor
  default: claude

# ä¿ç•™å‘åå…¼å®¹
agent: claude  # å·²åºŸå¼ƒï¼Œä½†ä»æ”¯æŒè¯»å–
```

#### 2.2.2 æ•°æ®ç»“æ„å˜æ›´

```python
# core/config.py

@dataclass
class AgentsConfig:
    """Multi-agent configuration for v1.2"""
    enabled: list[str] = field(default_factory=lambda: ["claude"])
    default: str = "claude"


@dataclass
class Config:
    version: str = "1.2"  # æ›´æ–°ç‰ˆæœ¬å·

    # v1.2: æ–°å¢å¤šå·¥å…·é…ç½®
    agents: AgentsConfig = field(default_factory=AgentsConfig)

    # å‘åå…¼å®¹: ä¿ç•™å•ä¸€ agent å­—æ®µï¼ˆå·²åºŸå¼ƒï¼‰
    agent: str = "claude"

    # å…¶ä»–å­—æ®µä¸å˜
    subagent: SubAgentConfig = field(default_factory=SubAgentConfig)

    def get_active_agent(self) -> str:
        """è·å–å½“å‰æ¿€æ´»çš„ agentï¼Œä¼˜å…ˆä½¿ç”¨ agents.default"""
        if self.agents.enabled:
            return self.agents.default
        return self.agent  # å‘åå…¼å®¹
```

#### 2.2.3 è¿ç§»ç­–ç•¥

```python
def load_config(config_path: Path) -> Config:
    """åŠ è½½é…ç½®ï¼Œè‡ªåŠ¨è¿ç§»æ—§æ ¼å¼"""
    data = yaml.safe_load(config_path.read_text())

    # è¿ç§»æ£€æµ‹
    if "agents" not in data and "agent" in data:
        # æ—§æ ¼å¼ï¼Œè‡ªåŠ¨è¿ç§»
        old_agent = data.get("agent", "claude")
        data["agents"] = {
            "enabled": [old_agent],
            "default": old_agent,
        }
        # æ ‡è®°éœ€è¦ä¿å­˜è¿ç§»åçš„é…ç½®

    return Config(**data)
```

### 2.3 å‘½ä»¤ç”Ÿæˆå™¨æ‰©å±•

#### 2.3.1 ç›®æ ‡

è¡¥å…¨è‡³ 17+ AI å·¥å…·æ”¯æŒã€‚

#### 2.3.2 æ–°å¢ç”Ÿæˆå™¨

```python
# core/command_generator.py

# ç°æœ‰ 9 ä¸ª:
# claude, cursor, gemini, copilot, amazonq, windsurf, qwen, codeium, continue

# v1.2 æ–°å¢:
class TabnineCommandGenerator(CommandGenerator):
    """Command generator for Tabnine."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".tabnine" / "commands"


class AiderCommandGenerator(CommandGenerator):
    """Command generator for Aider."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".aider" / "commands"


class DevinCommandGenerator(CommandGenerator):
    """Command generator for Devin."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".devin" / "commands"


class ReplitCommandGenerator(CommandGenerator):
    """Command generator for Replit AI."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".replit" / "commands"


class CodyCommandGenerator(CommandGenerator):
    """Command generator for Sourcegraph Cody."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".cody" / "commands"


class SupermavenCommandGenerator(CommandGenerator):
    """Command generator for Supermaven."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".supermaven" / "commands"


class KiloCodeCommandGenerator(CommandGenerator):
    """Command generator for Kilo Code."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".kilo" / "commands"


class AuggieCommandGenerator(CommandGenerator):
    """Command generator for Auggie."""
    file_format = "markdown"

    def get_command_dir(self, project_root: Path) -> Path:
        return project_root / ".auggie" / "commands"


# æ›´æ–°æ³¨å†Œè¡¨
COMMAND_GENERATORS: dict[str, type[CommandGenerator]] = {
    # ç°æœ‰
    "claude": ClaudeCommandGenerator,
    "cursor": CursorCommandGenerator,
    "gemini": GeminiCommandGenerator,
    "copilot": CopilotCommandGenerator,
    "amazonq": AmazonQCommandGenerator,
    "windsurf": WindsurfCommandGenerator,
    "qwen": QwenCommandGenerator,
    "codeium": CodeiumCommandGenerator,
    "continue": ContinueCommandGenerator,
    # v1.2 æ–°å¢
    "tabnine": TabnineCommandGenerator,
    "aider": AiderCommandGenerator,
    "devin": DevinCommandGenerator,
    "replit": ReplitCommandGenerator,
    "cody": CodyCommandGenerator,
    "supermaven": SupermavenCommandGenerator,
    "kilo": KiloCodeCommandGenerator,
    "auggie": AuggieCommandGenerator,
}
```

## 3. å¢å¼ºåŠŸèƒ½è®¾è®¡

### 3.1 update --templates çœŸå®æ›´æ–°

#### 3.1.1 ç›®æ ‡

ä»è¿œç¨‹ä»“åº“è·å–æœ€æ–°æ¨¡æ¿æ–‡ä»¶ã€‚

#### 3.1.2 å®ç°æ–¹æ¡ˆ

```python
# commands/update.py

TEMPLATE_BASE_URL = "https://raw.githubusercontent.com/user/cc-spec/main/templates/"

TEMPLATE_FILES = [
    "spec-template.md",
    "plan-template.md",
    "tasks-template.md",
    "checklist-template.md",
]


async def _update_templates(cc_spec_root: Path, force: bool) -> None:
    """ä»è¿œç¨‹æ›´æ–°æ¨¡æ¿æ–‡ä»¶"""
    templates_dir = cc_spec_root / "templates"
    templates_dir.mkdir(parents=True, exist_ok=True)

    console.print("[cyan]Fetching latest templates...[/cyan]")

    updated = 0
    for template_name in TEMPLATE_FILES:
        url = TEMPLATE_BASE_URL + template_name
        local_path = templates_dir / template_name

        try:
            # ä¸‹è½½æ¨¡æ¿
            content = await fetch_url(url)

            # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
            if local_path.exists() and not force:
                existing = local_path.read_text(encoding="utf-8")
                if existing == content:
                    console.print(f"  [dim]Skipped {template_name} (unchanged)[/dim]")
                    continue

            # å†™å…¥æ–‡ä»¶
            local_path.write_text(content, encoding="utf-8")
            console.print(f"  [green]âœ“[/green] Updated {template_name}")
            updated += 1

        except Exception as e:
            console.print(f"  [yellow]Warning:[/yellow] Failed to fetch {template_name}: {e}")

    if updated > 0:
        console.print(f"\n[green]âœ“[/green] Updated {updated} template(s)")
    else:
        console.print("[dim]All templates are up to date[/dim]")
```

### 3.2 goto è‡ªåŠ¨æ‰§è¡Œï¼ˆå¯é€‰ï¼‰

#### 3.2.1 ç›®æ ‡

é€‰æ‹©æ“ä½œåè‡ªåŠ¨æ‰§è¡Œå‘½ä»¤ï¼Œè€Œéåªæ‰“å°ã€‚

#### 3.2.2 å®ç°æ–¹æ¡ˆ

```python
# commands/goto.py

import subprocess


def _show_stage_options(
    change_id: str,
    state: ChangeState,
    force: bool,
    auto_execute: bool = False,  # v1.2 æ–°å¢
) -> None:
    """æ˜¾ç¤ºé˜¶æ®µé€‰é¡¹"""
    # ... ç°æœ‰ä»£ç  ...

    # æ‰¾åˆ°é€‰ä¸­çš„å‘½ä»¤
    for key, label, cmd in options:
        if key == choice:
            if auto_execute:
                # v1.2: è‡ªåŠ¨æ‰§è¡Œ
                console.print(f"\n[cyan]Executing:[/cyan] {cmd}")
                result = subprocess.run(cmd.split(), capture_output=True, text=True)
                if result.returncode == 0:
                    console.print(result.stdout)
                else:
                    console.print(f"[red]Error:[/red] {result.stderr}")
            else:
                # åŸæœ‰è¡Œä¸º: åªæ‰“å°
                console.print(f"\n[cyan]Run:[/cyan] {cmd}")
            break
```

## 4. æ•°æ®ç»“æ„æ±‡æ€»

### 4.1 config.yaml v1.2 æ ¼å¼

```yaml
version: "1.2"

# å¤šå·¥å…·é…ç½® (v1.2 æ–°å¢)
agents:
  enabled:
    - claude
    - cursor
    - gemini
  default: claude

# SubAgent é…ç½®
subagent:
  max_concurrent: 10
  timeout: 300000

  common:
    model: sonnet
    timeout: 300000
    permissionMode: acceptEdits
    tools: Read,Write,Edit,Glob,Grep,Bash

  profiles:
    quick:
      model: haiku
      timeout: 60000
      description: Quick tasks
    heavy:
      model: opus
      timeout: 600000
      description: Heavy tasks
    explore:
      model: sonnet
      timeout: 180000
      tools: Read,Glob,Grep,WebFetch,WebSearch
      description: Exploration tasks
```

### 4.2 tasks.md v1.2 æ ¼å¼

```markdown
## æ¦‚è§ˆ

| Wave | Task-ID | Profile | é¢„ä¼° | çŠ¶æ€ | ä¾èµ– |
|------|---------|---------|------|------|------|
| 0 | 01-SETUP | quick | 30k | ğŸŸ¦ ç©ºé—² | - |
| 1 | 02-MODEL | heavy | 80k | ğŸŸ¦ ç©ºé—² | 01-SETUP |

## ä»»åŠ¡è¯¦æƒ…

### Task: 01-SETUP
**Profile**: quick
**é¢„ä¼°ä¸Šä¸‹æ–‡**: ~30k tokens
**çŠ¶æ€**: ğŸŸ¦ ç©ºé—²
**ä¾èµ–**: æ— 

**Checklist**:
- [ ] åˆ†æéœ€æ±‚
- [ ] è®¾è®¡æ–¹æ¡ˆ
```

## 5. å‘åå…¼å®¹æ€§

### 5.1 Config å…¼å®¹

| å­—æ®µ | v1.0/v1.1 | v1.2 | å…¼å®¹æ€§ |
|------|-----------|------|--------|
| version | "1.0" / "1.1" | "1.2" | è‡ªåŠ¨è¿ç§» |
| agent | å•ä¸€å­—ç¬¦ä¸² | ä¿ç•™ä½†åºŸå¼ƒ | å®Œå…¨å…¼å®¹ |
| agents | ä¸å­˜åœ¨ | æ–°å¢ | è‡ªåŠ¨åˆå§‹åŒ– |

### 5.2 tasks.md å…¼å®¹

| å­—æ®µ | v1.0/v1.1 | v1.2 | å…¼å®¹æ€§ |
|------|-----------|------|--------|
| Profile | ä¸å­˜åœ¨ | å¯é€‰ | å®Œå…¨å…¼å®¹ï¼Œä¸æŒ‡å®šåˆ™ç”¨ common |

### 5.3 è¿ç§»è·¯å¾„

```python
def migrate_config_to_v12(config_path: Path) -> None:
    """å°† v1.0/v1.1 é…ç½®è¿ç§»åˆ° v1.2"""
    data = yaml.safe_load(config_path.read_text())

    # ç‰ˆæœ¬æ£€æµ‹
    version = data.get("version", "1.0")
    if version >= "1.2":
        return  # å·²æ˜¯æœ€æ–°ç‰ˆæœ¬

    # è¿ç§» agent -> agents
    if "agent" in data and "agents" not in data:
        old_agent = data["agent"]
        data["agents"] = {
            "enabled": [old_agent],
            "default": old_agent,
        }

    # æ›´æ–°ç‰ˆæœ¬å·
    data["version"] = "1.2"

    # ä¿å­˜
    yaml.safe_dump(data, config_path.open("w"), default_flow_style=False)
```

## 6. æµ‹è¯•ç­–ç•¥

### 6.1 å•å…ƒæµ‹è¯•

| æ¨¡å— | æµ‹è¯•æ–‡ä»¶ | è¦†ç›–å†…å®¹ |
|------|----------|----------|
| task_parser | test_task_parser.py | Profile è§£æ |
| config | test_config.py | agents å­—æ®µã€è¿ç§» |
| command_generator | test_command_generator.py | æ–°ç”Ÿæˆå™¨ |
| update | test_cmd_update.py | æ¨¡æ¿æ›´æ–° |

### 6.2 é›†æˆæµ‹è¯•

| åœºæ™¯ | æµ‹è¯•å†…å®¹ |
|------|----------|
| Profile æ‰§è¡Œæµç¨‹ | specify -> plan -> apply (with profile) |
| å¤šå·¥å…·åˆå§‹åŒ– | init --ai claude,cursor,gemini |
| é…ç½®è¿ç§» | æ—§é¡¹ç›®è‡ªåŠ¨å‡çº§åˆ° v1.2 |

## 7. æ–‡ä»¶å˜æ›´æ¸…å•

### 7.1 ä¿®æ”¹æ–‡ä»¶

| æ–‡ä»¶ | å˜æ›´å†…å®¹ |
|------|----------|
| `core/config.py` | AgentsConfig, Config.agents, version="1.2" |
| `subagent/task_parser.py` | TaskInfo.profile, Profile è§£æ |
| `core/command_generator.py` | 8+ æ–°ç”Ÿæˆå™¨ |
| `commands/update.py` | _update_templates çœŸå®å®ç° |
| `commands/apply.py` | é›†æˆ Profile é…ç½® |

### 7.2 æ–°å¢æ–‡ä»¶

| æ–‡ä»¶ | å†…å®¹ |
|------|------|
| `tests/test_v12_profile.py` | Profile åŠŸèƒ½æµ‹è¯• |
| `tests/test_v12_agents.py` | agents é…ç½®æµ‹è¯• |
| `tests/test_v12_generators.py` | æ–°ç”Ÿæˆå™¨æµ‹è¯• |

### 7.3 æ–‡æ¡£æ›´æ–°

| æ–‡ä»¶ | å˜æ›´å†…å®¹ |
|------|----------|
| `docs/plan/cc-spec-v1.1/05-ä»»åŠ¡æ‹†åˆ†.md` | æ›´æ–°ä»»åŠ¡çŠ¶æ€ |
| `docs/cc-spec/commands.md` | æ›´æ–°å‘½ä»¤å‚è€ƒ |
| `README.md` | æ›´æ–°ç‰ˆæœ¬ä¿¡æ¯ |
