# 04 - 实施步骤

## Gate 划分

### Gate 0: 准备阶段
**目标**: 确保开发环境就绪，v1.2 代码审计完成

**入口条件**:
- v1.2 功能稳定
- 历史设计文档审计完成
- v1.3 规划文档完整

**出口条件**:
- 开发分支创建
- 测试环境配置
- 依赖更新完成

### Gate 1: 核心功能
**目标**: 实现四维度打分、Git 锁、执行状态增强

**入口条件**:
- Gate 0 完成

**出口条件**:
- 四维度打分机制通过测试
- Git 锁机制通过测试
- 执行状态记录包含 agent_id
- 单元测试覆盖率 ≥ 80%

### Gate 2: 功能增强
**目标**: 实现 quick-delta 增强、文档完善

**入口条件**:
- Gate 1 完成

**出口条件**:
- quick-delta 能正确解析 git diff
- 全流程文档完成
- 集成测试通过

### Gate 3: 发布准备
**目标**: 测试、文档、发布

**入口条件**:
- Gate 2 完成

**出口条件**:
- 所有测试通过
- README 更新
- GitHub 仓库安装测试通过

## Wave 规划

### Wave 0: 基础设施 (串行)

| Task | 说明 | 预估 |
|------|------|------|
| 01-PREP | 创建开发分支，更新依赖 | ~20k |

### Wave 1: 配置扩展 (并行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 02-CONFIG-SCORING | 添加 ScoringConfig 数据结构 | ~30k | 01-PREP |
| 03-CONFIG-LOCK | 添加 LockConfig 数据结构 | ~25k | 01-PREP |

### Wave 2: 核心模块 (并行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 04-SCORING-REFACTOR | 重构 scoring.py 为四维度 | ~60k | 02-CONFIG-SCORING |
| 05-LOCK-MODULE | 新增 lock.py 模块 | ~50k | 03-CONFIG-LOCK |
| 06-STATE-ENHANCE | state.py 添加 agent_id 等字段 | ~30k | 01-PREP |

### Wave 3: 执行器集成 (串行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 07-EXECUTOR-LOCK | executor.py 集成锁机制 | ~40k | 05-LOCK-MODULE, 06-STATE-ENHANCE |
| 08-EXECUTOR-RESULT | ExecutionResult 添加 agent_id | ~25k | 06-STATE-ENHANCE |

### Wave 4: 命令更新 (并行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 09-CMD-CHECKLIST | checklist 命令使用新打分 | ~45k | 04-SCORING-REFACTOR |
| 10-CMD-APPLY | apply 命令集成锁 | ~40k | 07-EXECUTOR-LOCK |

### Wave 5: 增强功能 (并行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 11-QUICKDELTA-ENHANCE | quick-delta 解析 git diff | ~35k | 01-PREP |

### Wave 6: 测试补充 (并行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 12-TEST-SCORING | 四维度打分测试 | ~30k | 09-CMD-CHECKLIST |
| 13-TEST-LOCK | 锁机制测试 | ~30k | 10-CMD-APPLY |
| 14-TEST-QUICKDELTA | quick-delta 测试 | ~25k | 11-QUICKDELTA-ENHANCE |

### Wave 7: 文档与发布 (串行)

| Task | 说明 | 预估 | 依赖 |
|------|------|------|------|
| 15-DOCS | 全流程文档更新 | ~40k | 12-TEST-*, 13-TEST-*, 14-TEST-* |
| 16-RELEASE | 版本发布准备 | ~20k | 15-DOCS |

## 验收标准

### Gate 1 验收

```bash
# 1. 四维度打分测试
uv run pytest tests/test_scoring_v13.py -v

# 2. 锁机制测试
uv run pytest tests/test_lock.py -v

# 3. 状态增强测试
uv run pytest tests/test_state.py -v

# 4. checklist 命令测试
cc-spec checklist --help
# 输出应包含维度相关选项
```

### Gate 2 验收

```bash
# 1. quick-delta 测试
uv run pytest tests/test_quick_delta_v13.py -v

# 2. 手动测试 git diff 解析
git add .
cc-spec quick-delta "测试变更"
# 输出应包含 ADDED/MODIFIED/REMOVED 分类

# 3. 集成测试
uv run pytest tests/integration/ -v
```

### Gate 3 验收

```bash
# 1. 全部测试通过
uv run pytest --cov=cc_spec --cov-report=term-missing

# 2. 类型检查
uv run mypy src/cc_spec/

# 3. lint 检查
uv run ruff check src/

# 4. GitHub 安装测试
uvx --from git+https://github.com/Waasaabii/cc-spec.git@v1.3 cc-spec --version
```

## 时间线概览

```
Wave 0 ──→ Wave 1 ──→ Wave 2 ──→ Wave 3 ──→ Wave 4 ──→ Wave 5 ──→ Wave 6 ──→ Wave 7
  │          │          │          │          │          │          │          │
  │          │          │          │          │          │          │          │
01-PREP   02-CONFIG  04-SCORING  07-EXEC   09-CHECK  11-QUICK  12-TEST   15-DOCS
          03-CONFIG  05-LOCK     08-EXEC   10-APPLY            13-TEST   16-RELEASE
                     06-STATE                                  14-TEST
```

## 风险缓解

| 风险 | 缓解措施 |
|------|----------|
| 锁死锁 | 实现超时自动释放 + `cc-spec lock --cleanup` 命令 |
| 打分不准 | 允许用户自定义权重和关键词 |
| 向后兼容 | 版本检测 + 自动迁移 + 默认值 |
| git diff 解析失败 | 降级到 git log 信息 |
