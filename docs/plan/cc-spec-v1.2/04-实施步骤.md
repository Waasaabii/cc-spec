# cc-spec v1.2 - 实施步骤

## 1. 实施策略

### 1.1 原则

- **增量改进**: 在 v1.1 基础上小步迭代
- **向后兼容**: 不破坏现有项目
- **测试驱动**: 新功能必须有测试覆盖
- **文档同步**: 代码与文档保持一致

### 1.2 波次划分

| Wave | 主题 | 任务数 | 依赖 |
|------|------|--------|------|
| 0 | 文档同步 | 2 | 无 |
| 1 | 核心功能 | 4 | Wave 0 |
| 2 | 工具扩展 | 2 | Wave 0 |
| 3 | 增强功能 | 2 | 无 |
| 4 | 测试文档 | 3 | Wave 1-3 |

## 2. Wave 0: 文档同步

### Gate 0.1: 更新 v1.1 任务状态

**目标**: 修复 v1.1 任务文档与代码不同步的问题

**步骤**:
1. 打开 `docs/plan/cc-spec-v1.1/05-任务拆分.md`
2. 根据实际代码实现状态更新每个任务
3. 将已完成任务标记为 🟩 完成
4. 将部分完成任务标记为 🟨 进行中
5. 添加完成时间和简要说明

**验收标准**:
- [ ] 任务 20-33 状态与代码一致
- [ ] 每个完成任务有简要完成说明

### Gate 0.2: 更新 v1.1 概览文档

**目标**: 更新 v1.1 README 和 CONTINUE 文档

**步骤**:
1. 更新 `docs/plan/cc-spec-v1.1/README.md` 状态汇总
2. 标记 v1.1 为已完成状态
3. 添加指向 v1.2 的链接

**验收标准**:
- [ ] README 反映实际完成状态
- [ ] 有链接指向 v1.2 规划

## 3. Wave 1: 核心功能

### Gate 1.1: task_parser Profile 解析

**目标**: 支持任务级别的执行配置

**步骤**:
1. 修改 `src/cc_spec/subagent/task_parser.py`
   - 在 TaskInfo dataclass 添加 `profile: str | None = None`
   - 在 `_parse_task_section()` 添加 Profile 解析逻辑
2. 编写测试 `tests/test_task_parser.py`
   - 测试有 Profile 的任务解析
   - 测试无 Profile 的任务解析（兼容性）

**验收标准**:
- [ ] TaskInfo 包含 profile 字段
- [ ] 能正确解析 `**Profile**: quick` 格式
- [ ] 无 Profile 时 profile=None（向后兼容）
- [ ] 测试覆盖

### Gate 1.2: Config agents 字段

**目标**: 支持多 AI 工具配置

**步骤**:
1. 修改 `src/cc_spec/core/config.py`
   - 添加 AgentsConfig dataclass
   - 在 Config 添加 agents 字段
   - 添加 get_active_agent() 方法
   - 更新默认 version 为 "1.2"
2. 实现配置迁移逻辑
   - 检测旧格式自动迁移
   - 保留 agent 字段向后兼容
3. 编写测试 `tests/test_config.py`
   - 测试新格式加载
   - 测试旧格式迁移
   - 测试 get_active_agent()

**验收标准**:
- [ ] AgentsConfig 定义完整
- [ ] Config.agents 字段可用
- [ ] 旧配置自动迁移到新格式
- [ ] version 默认值为 "1.2"
- [ ] 测试覆盖

### Gate 1.3: apply 集成 Profile

**目标**: apply 命令根据任务 Profile 选择执行参数

**步骤**:
1. 修改 `src/cc_spec/commands/apply.py`
   - 在执行任务时读取 task.profile
   - 调用 config.subagent.get_profile(profile_name)
   - 使用返回的配置参数执行

**验收标准**:
- [ ] apply 能识别任务的 Profile
- [ ] 使用 Profile 配置执行任务
- [ ] 无 Profile 时使用 common 配置
- [ ] 测试覆盖

### Gate 1.4: init 集成多工具

**目标**: init 命令支持 agents 配置

**步骤**:
1. 修改 `src/cc_spec/commands/init.py`
   - 更新 --ai 参数处理
   - 生成 agents.enabled 配置
   - 设置 agents.default

**验收标准**:
- [ ] `cc-spec init --ai claude,cursor` 生成正确配置
- [ ] 配置文件包含 agents 字段
- [ ] 测试覆盖

## 4. Wave 2: 工具扩展

### Gate 2.1: 补全命令生成器

**目标**: 将工具支持从 9 个扩展到 17+

**步骤**:
1. 修改 `src/cc_spec/core/command_generator.py`
2. 添加以下生成器类:
   - TabnineCommandGenerator
   - AiderCommandGenerator
   - DevinCommandGenerator
   - ReplitCommandGenerator
   - CodyCommandGenerator
   - SupermavenCommandGenerator
   - KiloCodeCommandGenerator
   - AuggieCommandGenerator
3. 更新 COMMAND_GENERATORS 注册表
4. 编写测试

**验收标准**:
- [ ] 17+ 工具全部有生成器
- [ ] 每个生成器有正确的目录路径
- [ ] 测试覆盖

### Gate 2.2: 更新 update agents 列表

**目标**: update 命令显示完整工具列表

**步骤**:
1. 修改 `src/cc_spec/commands/update.py`
   - 更新 AVAILABLE_AGENTS 列表
   - 添加新工具名称

**验收标准**:
- [ ] `cc-spec update agents` 显示 17+ 工具
- [ ] 测试覆盖

## 5. Wave 3: 增强功能

### Gate 3.1: update --templates 真实更新

**目标**: 从远程获取最新模板

**步骤**:
1. 确定模板托管位置
   - 方案A: GitHub 仓库 raw 文件
   - 方案B: npm 包内置
   - 方案C: 本地 fallback
2. 修改 `src/cc_spec/commands/update.py`
   - 实现 `_update_templates()` 真实下载逻辑
   - 添加网络错误处理
   - 添加校验和验证（可选）

**验收标准**:
- [ ] 能从远程下载模板
- [ ] 网络失败时有友好提示
- [ ] force 参数强制覆盖
- [ ] 测试覆盖（mock 网络）

### Gate 3.2: goto 自动执行（可选）

**目标**: 选择后执行命令而非只打印

**步骤**:
1. 修改 `src/cc_spec/commands/goto.py`
   - 添加 --execute / -x 选项
   - 实现 subprocess 调用
   - 显示执行结果

**验收标准**:
- [ ] `cc-spec goto C-001 --execute` 自动执行选中命令
- [ ] 默认行为不变（只打印）
- [ ] 测试覆盖

## 6. Wave 4: 测试文档

### Gate 4.1: 单元测试补全

**目标**: 确保新功能测试覆盖

**步骤**:
1. 创建/更新测试文件:
   - `tests/test_task_parser.py` - Profile 解析
   - `tests/test_config.py` - agents 配置
   - `tests/test_command_generator.py` - 新生成器
   - `tests/test_cmd_update.py` - 模板更新
2. 运行测试确保通过:
   ```bash
   pytest tests/ -v
   ```

**验收标准**:
- [ ] 所有新功能有测试
- [ ] 测试通过率 100%
- [ ] 覆盖率 >= 80%

### Gate 4.2: 集成测试增强

**目标**: 端到端流程测试

**步骤**:
1. 更新 `tests/integration/test_v11_workflow.py`
   - 添加 Profile 执行流程测试
   - 添加多工具初始化测试
2. 创建 `tests/integration/test_v12_workflow.py`
   - 配置迁移测试
   - 完整工作流测试

**验收标准**:
- [ ] 集成测试覆盖主要场景
- [ ] CI 流程通过

### Gate 4.3: 文档更新

**目标**: 文档与代码同步

**步骤**:
1. 更新 `docs/cc-spec/commands.md`
   - 添加 Profile 使用说明
   - 更新 agents 配置说明
2. 更新 `README.md`
   - 版本信息
   - 新功能概览
3. 创建 `CHANGELOG.md`（如不存在）
   - 记录 v1.2 变更

**验收标准**:
- [ ] 命令参考文档完整
- [ ] README 版本信息更新
- [ ] CHANGELOG 记录变更

## 7. 验收检查清单

### 7.1 功能验收

- [ ] Profile 解析正常工作
- [ ] agents 配置正常工作
- [ ] 17+ 工具生成器可用
- [ ] update --templates 能下载模板
- [ ] 所有现有命令正常工作

### 7.2 兼容性验收

- [ ] v1.0/v1.1 项目能正常打开
- [ ] 旧配置自动迁移
- [ ] 无 Profile 任务正常执行

### 7.3 质量验收

- [ ] `pytest` 全部通过
- [ ] `mypy src/` 无错误
- [ ] `ruff check src/` 无警告
- [ ] 测试覆盖率 >= 80%

### 7.4 文档验收

- [ ] v1.1 任务状态已更新
- [ ] v1.2 设计文档完整
- [ ] 命令参考文档更新
- [ ] CHANGELOG 记录变更

## 8. 回滚计划

如果 v1.2 发布后出现严重问题:

1. **配置回滚**: 用户可手动将 version 改回 "1.1"
2. **代码回滚**: Git revert 到 v1.1 tag
3. **数据保护**: 用户数据（变更、任务）不受影响

## 9. 发布流程

1. **准备阶段**
   - 完成所有 Wave 任务
   - 通过验收检查清单
   - 更新版本号

2. **发布阶段**
   - 创建 v1.2.0 tag
   - 发布到 PyPI
   - 更新文档站点

3. **后续阶段**
   - 监控问题反馈
   - 处理 bug 修复
   - 规划 v1.3
