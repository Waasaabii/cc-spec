# cc-spec v0.1.9 plan (tasks.yaml)
# Notes: docs/plan is for human planning only.

version: "1.6"
change: "cc-spec-v0.1.9"

context:
  goals:
    - 修复 KB init 流程中的关键 bug
    - Codex 调用过程可见（终端 + SSE）
    - 提供外置可视化查看器（React + Vite + Tailwind v4 + Tauri）
  constraints:
    - 保持现有 API 兼容性
    - 复用已有参考实现，不重复造轮子
  references:
    - src/cc_spec/rag/chunker.py
    - src/cc_spec/codex/client.py
    - src/cc_spec/codex/streaming.py
    - .cc-spec/runtime/codex/stream.json
    - reference/skills/collaborating-with-codex/scripts/codex_bridge.py

meta:
  change_name: "cc-spec-v0.1.9"
  max_concurrent: 2

waves:
  - id: 0
    type: gate
    tasks:
      - BUG-001
  - id: 1
    type: wave
    tasks:
      - FEAT-001
  - id: 2
    type: wave
    tasks:
      - FEAT-002

tasks:
  BUG-001:
    name: fix-codexchunker-run-and-parse
    status: completed
    wave: 0
    deps: []
    desc: |
      ## 问题
      _run_and_parse 方法定义在 build_smart_chunker 函数的 return 语句之后（chunker.py:380），
      变成死代码，从未作为 CodexChunker 的方法被定义。

      ## 触发场景
      - KB init 处理 reference/** 下的文件时
      - 调用链: SmartChunker.chunk_file (line 52-57) → CodexChunker.chunk_file → self._run_and_parse
      - 错误: AttributeError: 'CodexChunker' object has no attribute '_run_and_parse'

      ## 背景说明
      - 主切片策略已改为 ast-only（使用 tree-sitter 开源方案）
      - 代码文件 (.py/.ts 等) → tree-sitter AST 切片 ✓
      - 其他文本文件 → line 本地行切片 ✓
      - reference 文件索引级入库 → 仍依赖 CodexChunker（触发 bug）

      ## 修复方案
      将 _run_and_parse 方法（chunker.py:380-450+）移入 CodexChunker 类内部，
      放在 chunk_file 方法之后、build_smart_chunker 函数之前。
    code:
      - src/cc_spec/rag/chunker.py
    checklist:
      - CodexChunker._run_and_parse 已在类内定义且可被实例调用
      - chunk_file 不再触发 AttributeError
      - build_smart_chunker 函数后无悬空代码
      - cc-spec kb init --reference-mode index 可正常执行
      - 保持现有 API 兼容性

  FEAT-001:
    name: codex-streaming-output
    status: completed
    wave: 1
    deps:
      - BUG-001
    desc: |
      ## 需求
      Codex 调用过程可见：终端实时输出 + SSE 事件流供前端展示。

      ## 当前问题
      CodexClient._run 使用 subprocess.run(capture_output=True)，
      stdout/stderr 被捕获，不显示到终端，用户看不到 Codex 执行过程。

      ## 参考实现
      直接复用 reference/skills/collaborating-with-codex/scripts/codex_bridge.py：
      - Popen + PIPE 流式读取
      - 多线程 + 队列逐行处理
      - 检测 turn.completed 事件判断完成

      ## 修改范围
      重构 src/cc_spec/codex/client.py 的 CodexClient._run 方法，
      将 subprocess.run 改为 Popen + 流式输出模式。

      ## SSE 输出要求（方案 A：全局订阅）
      - 仅保留 SSE（不做 UDP）
      - 启用开关：CC_SPEC_CODEX_SSE=1
      - 绑定地址：127.0.0.1（可配置端口）
      - 服务发现：写入 .cc-spec/runtime/codex/stream.json
      - 事件格式为 JSON 行，包含 run_id / session_id / stream / seq / text
      - 每次调用结束发送 codex.completed，前端收到后停止渲染该 run_id

      ## 注意事项
      - 保持 CodexResult 返回结构不变
      - 日志文件仍需写入 .cc-spec/runtime/codex/
      - 终端输出需可控制（环境变量或 TTY 默认策略）
    code:
      - src/cc_spec/codex/client.py
    checklist:
      - CodexClient._run 使用 Popen + 流式读取
      - Codex 执行过程实时显示到终端
      - CodexResult 返回结构保持兼容
      - 日志文件正常写入
      - SSE 可被外部 App 连接并展示
      - codex.completed 事件能正确结束 run_id 展示
      - KB init 过程可见 Codex 调用状态

  FEAT-002:
    name: codex-stream-viewer-app
    status: completed
    wave: 2
    deps:
      - FEAT-001
    desc: |
      ## 目标
      新建一个外置查看器目录，使用 React + Vite + Tailwind v4 + Tauri，
      用于展示 cc-spec Codex SSE 事件流，支持导入项目并识别 stream.json。

      ## 功能要求
      - 选择项目目录（Tauri dialog）或粘贴路径
      - 读取 .cc-spec/runtime/codex/stream.json 得到 host/port/path
      - 建立 SSE 连接，按 run_id 聚合输出
      - 收到 codex.completed 后停止该 run_id 的追加渲染
      - 支持断开/重连、错误提示、空态提示
      - 不引入后端依赖，前端优先使用 Tauri API + SSE

      ## 目录要求
      - 新目录：apps/cc-spec-viewer/
      - 包含 Vite + React + Tailwind v4 配置
      - 包含 src-tauri/ 最小可运行骨架

    code:
      - apps/cc-spec-viewer/package.json
      - apps/cc-spec-viewer/vite.config.ts
      - apps/cc-spec-viewer/src/
      - apps/cc-spec-viewer/src-tauri/
    checklist:
      - 目录 apps/cc-spec-viewer 创建完成
      - React + Vite + Tailwind v4 配置齐备
      - Tauri 基础配置与入口存在（src-tauri）
      - 可从 stream.json 解析 SSE 入口并连接
      - UI 可区分多个 run_id 且完成态停止更新
      - 有断开/重连/错误/空态提示
