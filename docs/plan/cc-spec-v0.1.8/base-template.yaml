# cc-spec 规范源模板 v1.0.8
#
# 用途：统一维护规范，init 时根据项目特点动态生成：
#   - .claude/skills/cc-spec-standards/SKILL.md（给 Claude）
#   - AGENTS.md（给 Codex）
#
# 说明：
#   - docs/plan/ 仅供人类阅读，不参与运行时配置或决策
#   - template_mapping 仅用于实现指引，运行时使用内置模板
#   - SKILL.md / AGENTS.md 是 CLI/Agent 指令产物
#
# 生成时机：Claude /cc-spec:init 分析项目后填充 project_specific 字段

version: "1.0.8"
name: cc-spec-standards

# ═══════════════════════════════════════════════════════════════════════════════
# 元信息
# ═══════════════════════════════════════════════════════════════════════════════
meta:
  generated_at: null          # init 时填充
  project_name: null          # init 时填充
  tech_stack: []              # init 时填充，如 [python, fastapi, postgresql]
  detected_frameworks: []     # init 时填充，如 [pydantic, sqlalchemy, alembic]

# ═══════════════════════════════════════════════════════════════════════════════
# 版本策略
# ═══════════════════════════════════════════════════════════════════════════════
versioning:
  description: cc-spec 版本号体系说明

  package_version:
    current: "0.1.8"
    format: "0.x.y"
    description: Python 包版本号，遵循语义化版本

  template_version:
    current: "1.0.8"
    format: "1.x.y"
    description: 规范模板版本号，1.0.x 表示初代稳定版

  config_version:
    current: "1.4"
    format: "x.y"
    description: config.yaml 格式版本，用于配置迁移

  kb_schema_version:
    current: "0.1.8"
    format: "0.x.y"
    description: KB 数据库 schema 版本，与包版本同步

# ═══════════════════════════════════════════════════════════════════════════════
# Init 生成规则
# ═══════════════════════════════════════════════════════════════════════════════
init:
  description: |
    cc-spec init 根据项目特点动态生成规范文件。
    Claude 分析项目后填充 project 字段，然后生成 SKILL.md 和 AGENTS.md。

  # ---------------------------------------------------------------------------
  # 生成产物
  # ---------------------------------------------------------------------------
  outputs:
    skill_md:
      path: .claude/skills/cc-spec-standards/SKILL.md
      target: Claude
      description: Claude 专属规范，包含角色定位、产出物、工作流程
      sections:
        - source: common（通用规范）
        - source: claude（Claude 专属规范）
        - source: project.coding_rules（项目编码规范）
        - source: project.architecture_rules（项目架构规范）
        - source: kb.retrieval（KB 检索配置）

    agents_md:
      path: AGENTS.md
      target: Codex
      description: Codex 专属规范，包含角色定位、执行规则、命令说明
      sections:
        - source: common（通用规范）
        - source: codex（Codex 专属规范）
        - source: project.coding_rules（项目编码规范）
        - source: project.naming_conventions（命名约定）

    config_yaml:
      path: .cc-spec/config.yaml
      description: 项目配置文件，包含 KB 策略、打分阈值等
      sections:
        - source: kb.chunking（切片策略）
        - source: kb.update（更新策略）
        - source: kb.retrieval（检索配置）

  # ---------------------------------------------------------------------------
  # 项目分析流程
  # ---------------------------------------------------------------------------
  analysis:
    description: Claude 分析项目的步骤

    steps:
      - step: 1
        name: 检测技术栈
        action: 扫描 pyproject.toml / package.json / go.mod 等
        output: meta.tech_stack, meta.detected_frameworks

      - step: 2
        name: 识别项目结构
        action: 分析目录结构和入口文件
        output: project.detected.language, project.detected.framework

      - step: 3
        name: 提取编码规范
        action: 读取 .editorconfig / .eslintrc / ruff.toml 等
        output: project.coding_rules

      - step: 4
        name: 分析架构模式
        action: 识别 MVC / DDD / 微服务等模式
        output: project.architecture_rules

      - step: 5
        name: 生成规范文件
        action: 根据模板和分析结果生成 SKILL.md / AGENTS.md
        output: .claude/skills/cc-spec-standards/SKILL.md, AGENTS.md

  # ---------------------------------------------------------------------------
  # 模板映射规则
  # ---------------------------------------------------------------------------
  template_mapping:
    description: base-template.yaml 字段到生成文件的映射

    skill_md_template: |
      # cc-spec Standards (for Claude)

      ## 角色定位
      {claude.role.rules}

      ## 产出物
      {claude.outputs.artifacts}

      ### 禁止产出
      {claude.outputs.forbidden}

      ## 工作流程
      {claude.workflow.phases}

      ## 项目编码规范
      {project.coding_rules}

      ## KB 规则
      ### 写入规则
      {claude.kb_write_rules.rules}

    agents_md_template: |
      # AGENTS.md (for Codex)

      ## 角色定位
      {codex.role.rules}

      ## 产出物
      {codex.outputs.artifacts}

      ### 禁止产出
      {codex.outputs.forbidden}

      ## 执行规则
      {codex.execution_rules.rules}

      ## 项目编码规范
      {project.coding_rules}

      ## 命令说明
      {codex.commands.list}

# ═══════════════════════════════════════════════════════════════════════════════
# 通用规范（所有 AI 工具共享）
# ═══════════════════════════════════════════════════════════════════════════════
common:

  code_sovereignty:
    title: 代码主权原则
    target: [claude, codex]
    rules:
      - Claude 作为主控 Agent，负责编排和审核
      - Codex 作为执行 Agent，直接修改代码文件
      - 所有变更通过 KB 传递上下文，确保可追溯
      - Claude 对最终结果负责，必要时介入修复

  output_format:
    title: 输出格式规范
    target: [codex, gemini]
    rules:
      - 返回结构化内容（JSON 或 Markdown）
      - 代码变更必须使用 Unified Diff 格式
      - 每次输出包含 summary 说明变更目的
      - 标注 affected_files 列表

  coding_style:
    title: 编码规范
    target: [claude, codex, gemini]
    rules:
      - 精简高效，无冗余代码
      - 非必要不生成注释与文档
      - 仅对需求做针对性改动，严禁影响现有功能
      - 遵循项目现有的代码风格和命名约定
    # [动态填充] Claude init 时根据项目技术栈添加
    project_specific: []

  security:
    title: 安全约束
    target: [codex, gemini]
    rules:
      - 默认使用 read-only 沙箱模式
      - 禁止执行危险操作（rm -rf、DROP TABLE 等）
      - 不输出敏感信息（密钥、密码、token）
      - 不执行网络请求或外部 API 调用

# ═══════════════════════════════════════════════════════════════════════════════
# Claude 专属规范（生成 SKILL.md）
# ═══════════════════════════════════════════════════════════════════════════════
claude:

  role:
    title: Claude 角色定位
    rules:
      - 作为主控 Agent（Orchestrator），负责需求分析和任务编排
      - 负责将需求/上下文写入 KB，供 Codex 读取
      - 不直接编写业务代码，代码实现由 Codex 完成
      - 负责审核 Codex 的执行结果，处理异常情况

  outputs:
    title: Claude 产出物
    description: Claude 的主要产出是 YAML/Markdown 规范文件，不产出业务代码
    artifacts:
      - type: proposal.md
        description: 变更提案（需求描述、影响范围、技术方案）
      - type: tasks.yaml
        description: 任务拆分（Wave/Task 结构、依赖关系、检查清单）
      - type: config.yaml
        description: 项目配置（工具选项、打分阈值、KB 策略）
      - type: base-template.yaml
        description: 规范模板（编码规范、架构约束、安全规则）
      - type: KB records
        description: 工作流记录（需求摘要、任务上下文、执行结果）
    forbidden:
      - 业务代码（.py, .ts, .js 等）
      - 测试代码（test_*.py, *.spec.ts 等）
      - 配置代码（除 cc-spec 相关的 yaml 外）

  core_principle:
    title: KB 信息桥梁原则
    description: KB 是 Claude 和 Codex 之间的信息桥梁
    flow:
      - step: 1
        actor: Claude
        action: 分析需求，理解上下文
      - step: 2
        actor: Claude
        action: 将需求/任务摘要写入 KB
      - step: 3
        actor: Codex
        action: 从 KB 读取上下文（需求 + 代码）
      - step: 4
        actor: Codex
        action: 直接执行任务（修改代码）
      - step: 5
        actor: Claude
        action: 审核结果，处理异常

  workflow:
    title: apply 工作流程
    phases:
      - phase: 1
        name: 需求分析与 KB 写入
        actor: Claude
        description: 分析需求并将关键信息写入 KB
        actions:
          - 阅读 proposal.md 和 tasks.yaml，理解任务目标
          - 将任务摘要/需求要点写入 KB
          - |
            cc-spec kb record --step apply --change "{change_name}" \
              --task-id "{task_id}" --notes "{task_summary}"
        notes: 确保 Codex 能从 KB 获取完整上下文

      - phase: 2
        name: 调用 Codex 执行
        actor: Claude (编排) → Codex (执行)
        description: 通过 cc-spec apply 调用 Codex 执行任务
        actions:
          - cc-spec apply --change "{change_name}"
        notes: |
          SubAgentExecutor 会自动：
          1. 从 KB 检索上下文（ContextProvider）
          2. 注入到 Codex prompt
          3. 调用 Codex CLI 执行
          4. 更新任务状态

      - phase: 3
        name: 结果审核
        actor: Claude
        description: 审核 Codex 执行结果
        actions:
          - 检查 tasks.yaml 中的任务状态
          - 若有失败任务，分析原因并决定是否重试
          - 若需要调整，更新 KB 后重新执行
        notes: Claude 不直接修改代码，而是通过调整需求/上下文让 Codex 重试

  kb_write_rules:
    title: KB 写入规则
    rules:
      - 需求分析完成后，必须将任务摘要写入 KB
      - 使用 cc-spec kb record 记录工作流步骤
      - 复杂需求拆解为多个 KB 条目，便于 Codex 检索
      - 写入内容包括：任务目标、技术要点、约束条件、参考文件

  kb_read_rules:
    title: KB 检索规则（供 Codex 使用）
    rules:
      - Codex 执行前由 SubAgentExecutor 自动检索 KB
      - 检索内容包括：需求上下文、相关代码片段、项目规范
      - 检索结果自动注入到 Codex prompt

  exception_handling:
    title: 异常处理
    rules:
      - 任务失败时，Claude 分析失败原因
      - 若是上下文不足，补充 KB 后重试
      - 若是需求不清晰，澄清后更新 KB 并重试
      - 若是 Codex 能力限制，Claude 可介入辅助（但优先让 Codex 完成）

# ═══════════════════════════════════════════════════════════════════════════════
# Codex 专属规范（生成 AGENTS.md）
# ═══════════════════════════════════════════════════════════════════════════════
codex:

  role:
    title: Codex 角色定位
    rules:
      - 作为执行 Agent，负责实际的代码编写和修改
      - 从 KB 获取上下文（需求 + 代码），理解任务目标
      - 直接执行任务，修改代码文件
      - 遵循项目规范，输出高质量代码

  outputs:
    title: Codex 产出物
    description: Codex 的主要产出是业务代码，不产出规范文件
    artifacts:
      - type: 业务代码
        description: 功能实现（.py, .ts, .js, .go 等）
      - type: 测试代码
        description: 单元测试、集成测试（test_*.py, *.spec.ts 等）
      - type: 配置文件
        description: 应用配置（非 cc-spec 相关）
      - type: 数据库迁移
        description: Schema 变更（migrations/）
    forbidden:
      - cc-spec 规范文件（proposal.md, tasks.yaml, base-template.yaml）
      - KB 记录（由 Claude 通过 cc-spec kb record 写入）
      - 工作流状态文件（status.yaml）

  core_principle:
    title: KB 驱动执行原则
    description: Codex 的上下文完全来自 KB
    flow:
      - step: 1
        action: 接收 prompt（已包含 KB 检索结果）
      - step: 2
        action: 理解需求和上下文
      - step: 3
        action: 执行代码修改
      - step: 4
        action: 返回执行结果

  context_source:
    title: 上下文来源
    rules:
      - 上下文由 SubAgentExecutor 从 KB 自动检索并注入
      - 包含：任务需求、相关代码片段、项目规范
      - 无需手动检索，专注于代码实现

  execution_rules:
    title: 执行规则
    rules:
      - 严格按照 prompt 中的任务要求执行
      - 遵循项目编码规范（从 KB 上下文获取）
      - 最小作用域，只改需求范围内的代码
      - 不擅自扩展需求范围

  output_rules:
    title: 输出规则
    rules:
      - 直接修改代码文件（非 Diff 模式）
      - 完成后更新相关测试（如有要求）
      - 复杂变更需添加必要注释
      - 遵循项目现有的代码风格

  commands:
    title: cc-spec 命令说明
    description: |
      本项目使用 cc-spec 工作流进行规格驱动的开发。
      以下是可用命令列表。
    list:
      - name: specify
        description: 创建新的变更规格说明
        usage: cc-spec specify <变更名称>

      - name: clarify
        description: 审查任务并标记需要返工的内容
        usage: cc-spec clarify

      - name: plan
        description: 从提案生成执行计划
        usage: cc-spec plan

      - name: apply
        description: 使用 SubAgent 并行执行任务
        usage: cc-spec apply

      - name: checklist
        description: 使用检查清单评分验证任务完成情况
        usage: cc-spec checklist

      - name: archive
        description: 归档已完成的变更
        usage: cc-spec archive

      - name: quick-delta
        description: 快速模式，一步创建并归档简单变更
        usage: cc-spec quick-delta <变更名称> "<变更描述>"

      - name: list
        description: 列出变更、任务、规格或归档
        usage: cc-spec list [changes|tasks|specs|archives]

      - name: goto
        description: 导航到特定变更或任务
        usage: cc-spec goto <变更名称>

      - name: update
        description: 更新配置、命令或模板
        usage: cc-spec update [config|commands|templates]

      - name: kb
        description: KB（向量库）相关命令
        subcommands:
          - name: kb init
            description: 全量构建 KB
          - name: kb update
            description: 增量更新 KB
          - name: kb query
            description: 向量检索
          - name: kb context
            description: 输出格式化上下文

  workflow_example:
    title: 工作流程示例
    steps:
      - 创建新变更：cc-spec specify add-user-auth
      - 编辑提案：.cc-spec/changes/add-user-auth/proposal.md
      - 生成执行计划：cc-spec plan
      - 执行任务：cc-spec apply
      - 验证完成：cc-spec checklist
      - 归档变更：cc-spec archive

# ═══════════════════════════════════════════════════════════════════════════════
# Gemini 专属规范（可选，未来扩展）
# ═══════════════════════════════════════════════════════════════════════════════
gemini:
  enabled: false  # 当前版本不启用

  role:
    title: Gemini 角色定位
    rules:
      - 前端/UI/样式 的分析和原型生成
      - 上下文限制 < 32K tokens
      - 后端逻辑建议需谨慎采纳

  sandbox:
    default: read-only

# ═══════════════════════════════════════════════════════════════════════════════
# 项目特定规范（init 时动态填充）
# ═══════════════════════════════════════════════════════════════════════════════
project:
  # 以下字段由 Claude /cc-spec:init 分析项目后填充

  detected:
    language: null           # python / typescript / go / ...
    framework: null          # fastapi / django / react / vue / ...
    package_manager: null    # uv / pip / pnpm / npm / ...
    test_framework: null     # pytest / jest / vitest / ...
    linter: null             # ruff / eslint / ...
    formatter: null          # black / prettier / ...

  coding_rules: []
  # 示例（Python + FastAPI 项目）：
  # - 使用 Pydantic v2 模型定义请求/响应
  # - 路由函数使用 async def
  # - 依赖注入使用 Depends()
  # - 错误处理使用 HTTPException
  # - 数据库操作使用 SQLAlchemy 2.0 异步语法

  architecture_rules: []
  # 示例：
  # - 遵循 src/ 目录结构
  # - API 路由放在 src/api/ 目录
  # - 数据模型放在 src/models/ 目录

  naming_conventions: []
  # 示例：
  # - 文件名使用 snake_case
  # - 类名使用 PascalCase
  # - 函数名使用 snake_case
  # - 常量使用 UPPER_SNAKE_CASE

  ignored_patterns: []
  # 示例：
  # - 不修改 migrations/ 目录下的文件
  # - 不修改 generated/ 目录下的文件

# ═══════════════════════════════════════════════════════════════════════════════
# KB 层配置（v1.0.8 新增）
# ═══════════════════════════════════════════════════════════════════════════════
kb:
  description: |
    KB（Knowledge Base）是 Claude 和 Codex 之间的信息桥梁。
    包含两类数据：代码切片（code chunks）和工作流记录（workflow records）。

  # ---------------------------------------------------------------------------
  # 参考项目与代码复用
  # ---------------------------------------------------------------------------
  references:
    description: Smart Chunking 功能的开源项目参考

    astchunk:
      repo: https://github.com/yilinjz/astchunk
      license: MIT
      paper: https://arxiv.org/abs/2506.15655
      description: AST-based 代码切片核心算法
      copy_files:
        - source: astchunk/chunker.py
          target: src/cc_spec/rag/chunker.py
          modifications:
            - 替换语言检测逻辑，使用 tree-sitter-language-pack
            - 移除 Java/C# 特定的硬编码，改为动态语言支持
            - 添加 fallback 到 line-based chunking
        - source: astchunk/utils.py
          target: src/cc_spec/rag/ast_utils.py
          modifications:
            - 仅复制 AST 遍历相关函数
            - 适配 cc-spec 的日志和错误处理

    tree_sitter_language_pack:
      package: tree-sitter-language-pack
      pypi: https://pypi.org/project/tree-sitter-language-pack/
      description: 100+ 编程语言的 tree-sitter parser 支持
      usage: |
        替代 astchunk 原有的 4 语言硬编码支持，
        通过 get_language() 动态获取任意语言的 parser

  # ---------------------------------------------------------------------------
  # Smart Chunking 策略配置
  # ---------------------------------------------------------------------------
  chunking:
    strategy: smart  # smart | codex-only | ast-only

    # Tier 1: AST-based chunking（0 token，毫秒级）
    ast:
      enabled: true
      max_chunk_chars: 2000        # 每个 chunk 最大非空白字符数
      chunk_overlap_nodes: 1       # 相邻 chunk 重叠的 AST 节点数
      supported_extensions:
        - .py
        - .ts
        - .tsx
        - .js
        - .jsx
        - .go
        - .rs
        - .java
        - .kt
        - .cs
        - .c
        - .cpp
        - .h
        - .hpp
        - .rb
        - .php
        - .swift
        - .scala

    # Tier 2: Line-based chunking（0 token，用于不支持 AST 的文件）
    line:
      lines_per_chunk: 100
      overlap_lines: 10

    # Tier 3: LLM-based chunking（高 token，高质量摘要）
    llm:
      enabled: true
      priority_files:              # 入口文件使用 LLM 生成高质量摘要
        - readme.md
        - readme
        - main.py
        - app.py
        - index.ts
        - index.js
        - __init__.py
        - setup.py
        - pyproject.toml
        - package.json
      max_content_chars: 120000    # 防止超长输入

  # ---------------------------------------------------------------------------
  # KB 数据层设计
  # ---------------------------------------------------------------------------
  layers:
    # Layer 1: 代码切片（Code Chunks）
    code_chunks:
      description: 项目代码的语义切片，支持向量检索
      update_strategy: incremental  # incremental | full
      content:
        - type: code
          description: 业务代码（函数、类、模块）
        - type: config
          description: 配置文件（yaml, toml, json）
        - type: doc
          description: 文档（md, rst, txt）
        - type: reference
          description: 参考资料（reference/ 目录）

    # Layer 2: 工作流记录（Workflow Records）
    workflow_records:
      description: Claude 写入的需求/任务上下文，供 Codex 读取
      content:
        - step: specify
          description: 需求规格说明
        - step: plan
          description: 执行计划
        - step: apply
          description: 任务执行上下文（需求摘要、技术要点）
        - step: checklist
          description: 验收结果

  # ---------------------------------------------------------------------------
  # KB 更新策略
  # ---------------------------------------------------------------------------
  update:
    # 任务完成后的 KB 同步策略
    post_task_sync:
      enabled: true
      strategy: smart              # smart | full | skip
      description: |
        任务完成后，智能判断是否需要更新 KB：
        - smart: 根据文件变更自动判断（增量更新修改的文件）
        - full: 全量重建 KB（适合大规模重构后）
        - skip: 不自动更新（手动 kb update）

    # 增量更新触发条件
    incremental_triggers:
      - file_modified              # 文件被修改
      - file_added                 # 新增文件
      - file_deleted               # 文件被删除
      - file_renamed               # 文件重命名

    # 排除自动更新的路径
    exclude_patterns:
      - "*.pyc"
      - "__pycache__/**"
      - ".git/**"
      - "node_modules/**"
      - ".cc-spec/**"

  # ---------------------------------------------------------------------------
  # 上下文检索配置（ContextProvider）
  # ---------------------------------------------------------------------------
  retrieval:
    # Codex 执行前的上下文检索
    pre_execution:
      enabled: true
      sources:
        - workflow_records         # 优先：任务需求上下文
        - code_chunks              # 其次：相关代码片段
      max_chunks: 10               # 最多检索 N 个 chunk
      max_tokens: 8000             # 上下文 token 上限

    # 检索策略
    strategy:
      type: hybrid                 # hybrid | semantic | keyword
      description: |
        - hybrid: 语义 + 关键词混合检索（默认，效果最好）
        - semantic: 纯向量相似度检索
        - keyword: 纯关键词匹配

    # 相关性阈值
    relevance:
      min_score: 0.5               # 最低相关性分数
      boost_same_file: 1.5         # 同文件 boost 系数
      boost_recent_workflow: 2.0   # 近期工作流记录 boost 系数
