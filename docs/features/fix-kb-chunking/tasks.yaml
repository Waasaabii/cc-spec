# fix-kb-chunking - KB init 切片问题修复
# 创建时间: 2025-12-18
# 问题: Codex 语义切片失败时，fallback chunk 存储 prompt 而非文件内容

version: "1.6"
change_id: C-002
change_name: fix-kb-chunking
priority: high
status: in_progress

# 问题摘要
problem: |
  KB init 时所有文件的 Codex 语义切片失败：
  - 向量库中 99.5% 的文档显示 "fallback chunk for {file_path}"
  - fallback chunk 的 content 字段存储的是切片 prompt，而非文件内容
  - 导致向量检索结果无意义

# 根本原因
root_cause: |
  1. chunker.py:85 - Codex 执行失败时，_fallback_chunk_dict 接收的是 prompt 而非文件内容
  2. client.py:107-111 - 日志写入失败被 try-except 静默吞掉
  3. pipeline.py:54-59 - 没有统计切片成功/失败数量

waves:
  - id: W1
    name: "诊断和日志能力增强"
    status: pending
    tasks:
      - id: W1-T1
        title: "增强 Codex 日志能力"
        status: pending
        files:
          - src/cc_spec/codex/client.py
        changes:
          - 改进日志写入，记录完整执行信息（stdout/stderr/cmd/exit_code/duration）
          - 日志写入失败时输出警告到 stderr（而非静默吞掉）
          - 使用结构化 JSON 格式便于调试
        verify: |
          ls -la .cc-spec/runtime/codex/
          cat .cc-spec/runtime/codex/*.log | head -20

      - id: W1-T2
        title: "添加 ChunkResult 数据结构"
        status: pending
        files:
          - src/cc_spec/rag/models.py
          - src/cc_spec/rag/chunker.py
        changes:
          - 在 models.py 新增 ChunkStatus 枚举（SUCCESS/FALLBACK_EXEC/FALLBACK_PARSE/FALLBACK_EMPTY）
          - 新增 ChunkResult 数据类（chunks + status + error_message）
          - 修改 chunker.py 的 chunk_file 返回 ChunkResult 而非 list[Chunk]
        verify: |
          uv run pytest tests/rag/ -v -k chunk

      - id: W1-T3
        title: "在 pipeline 添加切片统计"
        status: pending
        files:
          - src/cc_spec/rag/pipeline.py
        changes:
          - 扩展 KBUpdateSummary 添加 chunking_success/chunking_fallback/chunking_failed 字段
          - 添加 fallback_files 列表（记录失败的文件路径）
          - init_kb 完成后输出切片质量报告
        verify: |
          uv run cc-spec kb status

  - id: W2
    name: "修复 fallback 逻辑"
    status: pending
    depends_on: [W1]
    tasks:
      - id: W2-T1
        title: "修复 fallback 存储文件内容"
        status: pending
        files:
          - src/cc_spec/rag/chunker.py
        changes:
          - chunk_file 方法读取文件内容后，将 raw_content 传递给 _run_and_parse
          - 修改 _run_and_parse 签名，添加 raw_content 参数
          - 修改 fallback 逻辑：使用 raw_content 而非 prompt 作为 chunk 内容
        verify: |
          rm -rf .cc-spec/vectordb && uv run cc-spec kb init
          uv run python -c "
          import chromadb
          c = chromadb.PersistentClient('.cc-spec/vectordb')
          col = c.get_collection('chunks')
          r = col.get(limit=3, include=['documents','metadatas'])
          for d,m in zip(r['documents'],r['metadatas']):
              print(f'{m.get(\"source_path\")}: {d[:80]}...')
          "

      - id: W2-T2
        title: "实现简单文本切分后备方案"
        status: pending
        files:
          - src/cc_spec/rag/chunker.py
        changes:
          - 新增 _simple_text_chunks() 函数
          - 基于行的重叠切分策略（默认 100 行/块，10 行重叠）
          - fallback 时调用此函数生成多个小 chunk（而非单个大 chunk）
        verify: |
          uv run pytest tests/rag/ -v -k fallback

  - id: W3
    name: "添加调试模式"
    status: pending
    depends_on: [W1, W2]
    tasks:
      - id: W3-T1
        title: "添加 --verbose 选项"
        status: pending
        files:
          - src/cc_spec/commands/kb.py
          - src/cc_spec/rag/pipeline.py
        changes:
          - 在 kb init/update 命令添加 --verbose/-v 选项
          - pipeline 添加 progress_callback 参数
          - verbose 模式下输出每个文件的处理状态和结果
        verify: |
          uv run cc-spec kb init --verbose 2>&1 | head -30

  - id: W4
    name: "改进错误处理"
    status: pending
    depends_on: [W1]
    tasks:
      - id: W4-T1
        title: "区分失败类型"
        status: pending
        files:
          - src/cc_spec/codex/models.py
          - src/cc_spec/codex/client.py
        changes:
          - 在 models.py 新增 CodexErrorType 枚举（NONE/NOT_FOUND/TIMEOUT/EXEC_FAILED/PARSE_FAILED）
          - 扩展 CodexResult 添加 error_type 字段
          - client.py 的 _run 方法根据 exit_code 设置正确的 error_type
        verify: |
          uv run pytest tests/codex/ -v

      - id: W4-T2
        title: "添加重试机制"
        status: pending
        files:
          - src/cc_spec/rag/chunker.py
        changes:
          - ChunkingOptions 添加 max_retries（默认 2）和 retry_delay_s（默认 1.0）
          - _run_and_parse 对超时错误实现重试逻辑
          - 记录重试次数到日志
        verify: |
          uv run pytest tests/rag/ -v -k retry

# 验收标准
acceptance_criteria:
  - Codex 日志正确写入 .cc-spec/runtime/codex/
  - fallback chunks 存储的是文件内容而非 prompt
  - kb init 输出切片成功/失败统计
  - --verbose 模式显示详细处理过程
  - 对超时错误有重试机制
  - 所有现有测试通过
