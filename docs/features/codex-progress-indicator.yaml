# Codex è¾“å‡ºè¿›åº¦æŒ‡ç¤ºå™¨åŠŸèƒ½è®¾è®¡
# è§£å†³é—®é¢˜ï¼šè°ƒç”¨ Codex æ—¶ JSONL æµå¼è¾“å‡ºå ç”¨ç»ˆç«¯å¤§éƒ¨åˆ†å†…å®¹
# å‚è€ƒï¼šreference/skills/collaborating-with-codex/scripts/codex_bridge.py

feature:
  name: codex-progress-indicator
  description: ç”¨ç®€æ´çš„è¿›åº¦æŒ‡ç¤ºå™¨æ›¿ä»£åŸå§‹ JSONL æµå¼è¾“å‡º
  status: in_progress

# è¾“å‡ºæ¨¡å¼è®¾è®¡
output_modes:
  - name: stream
    description: åŸå§‹æµå¼è¾“å‡ºï¼ˆæ‰“å°æ‰€æœ‰ JSONL è¡Œï¼‰
    env_value: "stream"
    use_case: è°ƒè¯•æˆ–éœ€è¦æŸ¥çœ‹å®Œæ•´è¾“å‡ºæ—¶

  - name: progress
    description: è¿›åº¦æŒ‡ç¤ºæ¨¡å¼ï¼ˆSpinner + çŠ¶æ€æ›´æ–° + å®Œæˆæ‘˜è¦ï¼‰
    env_value: "progress"
    use_case: æ—¥å¸¸ä½¿ç”¨ï¼Œç®€æ´æ˜äº†
    is_default: true  # ç»ˆç«¯ç¯å¢ƒé»˜è®¤

  - name: quiet
    description: é™é»˜æ¨¡å¼ï¼ˆåªæ˜¾ç¤ºæœ€ç»ˆç»“æœï¼‰
    env_value: "quiet"
    use_case: CI/CD æˆ–è„šæœ¬è°ƒç”¨

# ç¯å¢ƒå˜é‡æ§åˆ¶
env_variables:
  - name: CC_SPEC_CODEX_OUTPUT
    values: ["stream", "progress", "quiet"]
    description: æ–°çš„è¾“å‡ºæ¨¡å¼æ§åˆ¶å˜é‡
    priority: 1

  - name: CC_SPEC_CODEX_STREAM
    values: ["true", "false"]
    description: å…¼å®¹æ—§å˜é‡ï¼ˆtrue=stream, false=quietï¼‰
    priority: 2
    deprecated: true

# è¿›åº¦æŒ‡ç¤ºå™¨æ˜¾ç¤ºå†…å®¹
progress_indicator:
  spinner_type: dots

  status_messages:
    - event: thread.started
      display: "ğŸŸ¢ ä¼šè¯å·²å¯åŠ¨"

    - event: item.started (tool_call)
      display: "âš™ï¸ æ‰§è¡Œ: {tool_name}"

    - event: item.completed (agent_message)
      display: "ğŸ’¬ å“åº”: {preview_30_chars}..."

    - event: turn.completed
      display: "âœ… æ‰§è¡Œå®Œæˆ"

  elapsed_time: true  # æ˜¾ç¤ºå·²è€—æ—¶

# å®Œæˆæ‘˜è¦æ ¼å¼
completion_summary:
  success_format: |
    âœ… Codex æ‰§è¡ŒæˆåŠŸ
       â±ï¸  è€—æ—¶: {duration}s
       ğŸ”‘ ä¼šè¯: {session_id_short}...
       ğŸ”§ å·¥å…·: {tool_list}
       ğŸ“Š äº‹ä»¶: {events_count}
       ğŸ’¬ å›å¤: {message_preview_100_chars}...

  failure_format: |
    âŒ Codex æ‰§è¡Œå¤±è´¥
       â±ï¸  è€—æ—¶: {duration}s
       ğŸ’¬ å›å¤: {error_message}

# å®ç°æ–‡ä»¶
implementation:
  new_files:
    - path: src/cc_spec/codex/progress.py
      description: è¿›åº¦æŒ‡ç¤ºå™¨ç±»å’Œäº‹ä»¶è§£æ
      classes:
        - OutputMode  # è¾“å‡ºæ¨¡å¼æšä¸¾
        - CodexEventInfo  # äº‹ä»¶ä¿¡æ¯æ•°æ®ç±»
        - CodexProgressIndicator  # è¿›åº¦æŒ‡ç¤ºå™¨ä¸»ç±»
      functions:
        - parse_codex_event  # è§£æå•è¡Œ JSONL äº‹ä»¶

  modified_files:
    - path: src/cc_spec/codex/client.py
      changes:
        - description: æ·»åŠ å¯¼å…¥ CodexProgressIndicator, OutputMode
          location: imports

        - description: æ·»åŠ  _get_output_mode() å‡½æ•°
          location: after _env_bool function

        - description: ä¿®æ”¹ _should_stream_to_terminal() ä½¿ç”¨æ–°æ¨¡å¼
          location: function body

        - description: åœ¨ _run() ä¸­æ ¹æ®æ¨¡å¼ä½¿ç”¨è¿›åº¦æŒ‡ç¤ºå™¨
          location: _run method
          details:
            - åˆ›å»º CodexProgressIndicator å®ä¾‹ï¼ˆprogress æ¨¡å¼ï¼‰
            - è°ƒç”¨ progress.start() å¼€å§‹æ˜¾ç¤º
            - åœ¨ _emit_event ä¸­è°ƒç”¨ progress.process_line()
            - å®Œæˆåè°ƒç”¨ progress.stop() æ˜¾ç¤ºæ‘˜è¦

# Codex JSONL äº‹ä»¶ç±»å‹ï¼ˆä¾›è§£æå‚è€ƒï¼‰
codex_events:
  - type: thread.started
    key_fields: [thread_id]

  - type: item.started
    key_fields: [item.type, item.name]
    item_types: [function_call_request, tool_use, function_call]

  - type: item.completed
    key_fields: [item.type, item.text]
    item_types: [agent_message]

  - type: turn.completed
    key_fields: []

# æµ‹è¯•ç”¨ä¾‹
test_cases:
  - name: test_output_mode_env_priority
    description: æµ‹è¯•ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§

  - name: test_progress_indicator_start_stop
    description: æµ‹è¯•è¿›åº¦æŒ‡ç¤ºå™¨å¯åŠ¨å’Œåœæ­¢

  - name: test_event_parsing
    description: æµ‹è¯• JSONL äº‹ä»¶è§£æ

  - name: test_summary_output
    description: æµ‹è¯•å®Œæˆæ‘˜è¦è¾“å‡ºæ ¼å¼
